## 前提・要約
- 目的：
  - カメラで撮影して「この画像を使う」を選んだ画像を、手動入力フォーム上で参照できる状態にし、画像を見ながら血圧値を入力→記録できる導線を完成させる。
- 成果物：
  - 入力フォーム上部の「撮影画像プレビュー」表示（拡大モーダル/削除付き）
  - camera.js → app.js への画像受け渡し（イベント/コールバック）
  - 撮影画像がある時のフォームUX（プレースホルダ/ヒント/状態表示）
  - （オプション）記録データへ画像添付の保存方針（保存する/しない・容量対策）
- 対象の種類（推定）：
  - 新規機能追加（Phase 2の新規カメラ機能に伴う、入力画面の拡張）
- 成功条件（Done）：
  - 「カメラで撮影」→プレビュー→「この画像を使う」後に、入力画面上部に画像が表示される
  - 画像をタップすると拡大表示（モーダル）が開閉できる
  - 画像の削除（破棄）で、表示が消え、フォームが通常状態に戻る
  - 画像がある状態でも、手動入力→保存（ローカル/Sheets）まで既存フローが壊れない
- 前提（仮定した点があれば明記）：
  - Step 2-1〜2-3（カメラ起動、撮影、プレビュー、ガイド枠）は実装済みで、撮影結果の画像データ（Blob もしくは Base64 DataURL）を取得できる。
  - 既存の手動入力（Phase 1）の保存ロジックは `js/app.js` にあり、フォーム描画も同ファイルが担う。
  - 画像保存は「まずは入力補助としての一時保持」をデフォルトとし、永続保存はオプション扱いとする。
- 主要な制約：
  - PWA/モバイル環境での localStorage 容量制約（画像を Base64 で持つと急増）
  - カメラストリーム/画像オブジェクトのメモリリークを避ける（モーダル閉鎖時・再撮影時）
- 既知の不明点（あれば）：
  - 「画像も記録と一緒に保存」を最終的に有効化するか（Phase 3 OCRや将来の閲覧要件次第）

## 全体ステップ構成
- Step1: 連携I/Fと状態管理方針の確定（camera.js ↔ app.js）
- Step2: 入力画面への画像プレビューUI追加
- Step3: 拡大モーダル・削除・再撮影時の状態遷移
- Step4: （オプション）画像の永続保存方針と実装
- Step5: テスト/デバッグ（実機中心）

---

## Step1: 連携I/Fと状態管理方針の確定（camera.js ↔ app.js）
### Plan 1: 「撮影画像の受け渡し契約」を決める（イベント or コールバック）
- 目的：
  - camera.js で確定した画像を、app.js が確実に受け取って画面状態を更新できるようにする。
- 作業内容（チェックリスト）：
  - [ ] camera.js 側の「この画像を使う」確定タイミングを特定（ボタン押下時）
  - [ ] 受け渡し方式を決める
    - 例）CustomEvent（`image:selected`）を `window`/`document` に dispatch
    - 例）camera.js が `onImageSelected(callback)` のような登録口を提供
  - [ ] 画像データ形式を統一
    - 推奨：表示用は DataURL（縮小後）／将来OCR用は元Blobも保持できる設計（ただし本Stepでは最低限でOK）
  - [ ] app.js 側の「現在選択中の画像」状態（in-memory）を用意
  - [ ] 再撮影・キャンセル時に状態がどうなるかを整理（状態遷移表をメモで残す）
- 変更対象（想定ファイル/モジュール）：
  - `js/camera.js`
  - `js/app.js`
- 受け入れ基準（完了条件）：
  - app.js が「画像確定イベント/コールバック」を受けて、画像データ（少なくとも表示可能な形式）を取得できる
  - 再撮影/閉じる等で「画像未選択」に戻す手段が用意されている
- テスト/検証：
  - ブラウザの Console でイベント発火・payload（画像の長さ/型）の確認
- 依存関係・注意点：
  - Step 2-2 の「画像サイズ最適化（長辺1280px程度）」「向き補正」が camera.js 内にある前提
- リスクと回避策：
  - リスク：DataURL が大きすぎて UI が重い
  - 回避：プレビュー用はさらに縮小（例：長辺 720〜960px）し、必要なら元データは別保持（本Stepでは必須にしない）

---

## Step2: 入力画面への画像プレビューUI追加
### Plan 2: 入力フォーム上部に「撮影画像プレビュー枠」を追加
- 目的：
  - 画像を見ながら数値を入力できるよう、入力フォームの視線移動を最小化する。
- 作業内容（チェックリスト）：
  - [ ] `index.html` に「画像プレビューエリア」を配置（入力フォームの直上）
  - [ ] 画像未選択時は非表示またはプレースホルダ表示（例：「撮影するとここに画像が表示されます」）
  - [ ] 画像選択時はサムネイル表示（タップ可能）
  - [ ] 削除ボタン（× / ゴミ箱）を画像枠に重ねて配置
  - [ ] フォームの入力欄プレースホルダにヒント追加（例：「画像を見ながら入力」）
  - [ ] 画像表示中の状態ラベル追加（例：「撮影画像を参照中」）
- 変更対象（想定ファイル/モジュール）：
  - `index.html`
  - `css/style.css`
  - `js/app.js`
- 受け入れ基準（完了条件）：
  - 画像確定後、フォームの上部にサムネイルが常に表示される
  - スマホ画面でフォームと画像の両方が無理なく見える（縦スクロール最小）
- テスト/検証：
  - 画面幅（小〜大）での表示崩れがない（Chrome DevTools の mobile viewport）
- 依存関係・注意点：
  - 画像の縦横比が端末により異なるため、CSS で `object-fit` 等を想定
- リスクと回避策：
  - リスク：画像枠が大きすぎてフォームが押し下げられる
  - 回避：サムネイルは高さ上限（例：160〜220px）を設け、拡大はモーダルへ委譲

---

## Step3: 拡大モーダル・削除・再撮影時の状態遷移
### Plan 3: 画像タップで拡大表示（モーダル）を実装
- 目的：
  - サムネイルでは読めない数字を、拡大して確認できるようにする。
- 作業内容（チェックリスト）：
  - [ ] モーダルUI（全画面 or 画面中央）を追加
  - [ ] タップで開く／背景タップ or 閉じるボタンで閉じる
  - [ ] iOS/Android のスクロール固定（モーダル表示中に背面が動かない）
  - [ ] 画像の最大表示（画面内に収める：contain）
- 変更対象（想定ファイル/モジュール）：
  - `index.html`
  - `css/style.css`
  - `js/app.js`
- 受け入れ基準（完了条件）：
  - サムネイルタップで拡大表示が開き、閉じると元の入力状態に戻る
- テスト/検証：
  - 連続で開閉しても表示が崩れない／操作が遅くならない
- 依存関係・注意点：
  - camera.js のプレビュー画面（既存モーダル）とモーダルが二重にならない導線にする
- リスクと回避策：
  - リスク：モーダルが多重起動して閉じられない
  - 回避：表示フラグでガード、フォーカス/スクロールロックを一箇所に集約

### Plan 4: 画像削除・再撮影・保存後の状態リセットを整備
- 目的：
  - 「誤って撮影した」「入力が終わった」などのケースで、画像状態を適切にリセットする。
- 作業内容（チェックリスト）：
  - [ ] 削除ボタンで「現在画像」を破棄
    - UI非表示 + 参照状態ラベル解除 + プレースホルダ復帰
  - [ ] 「再撮影」フローで新しい画像が来たら古い画像を置き換え
  - [ ] 「記録する」成功時に画像をどうするか決定
    - デフォルト：フォームクリア時に画像もクリア（次の入力へ）
    - オプション：保存するなら、そのまま履歴に紐付け
  - [ ] camera.js 側の一時ストレージ（sessionStorage など）を使う場合はクリアタイミングを統一
- 変更対象（想定ファイル/モジュール）：
  - `js/app.js`
  - `js/camera.js`
- 受け入れ基準（完了条件）：
  - 削除・再撮影・記録完了の各ケースで、画像状態とUIが一貫している
- テスト/検証：
  - 画像選択→削除→再撮影→保存→フォームクリアの一連操作が破綻しない
- 依存関係・注意点：
  - 既存の「クリア」ボタン仕様（日時を現在に戻す等）と整合
- リスクと回避策：
  - リスク：画像オブジェクトURLや大きなDataURLが残り続けてメモリ圧迫
  - 回避：破棄時に参照を null に戻す／必要なら objectURL を revoke

---

## Step4: （オプション）画像の永続保存方針と実装
### Plan 5: 「画像も保存」オプションの設計（最小の実装で安全に）
- 目的：
  - 将来の見返しやOCR検証用に画像を残したい場合に備えつつ、容量爆発を防ぐ。
- 作業内容（チェックリスト）：
  - [ ] 画像保存の要否を決める（デフォルトOFF推奨）
  - [ ] 保存する場合の仕様を決める
    - 保存先：localStorage（小規模） or IndexedDB（推奨、ただし本Stepでは導入スパイク扱いも可）
    - 保存形式：縮小JPEG（品質 0.7〜0.8 目安）
    - 保存サイズ上限：例 200KB〜500KB を目標
  - [ ] 記録データ構造の拡張方針（例：`imageDataUrl` / `imageId`）をメモ
  - [ ] 保存時の失敗（容量不足）に備えたフォールバック（画像は捨てて数値だけ保存）
- 変更対象（想定ファイル/モジュール）：
  - `js/app.js`
  - （必要なら）`js/camera.js`
- 受け入れ基準（完了条件）：
  - 「保存する」設定時のみ、記録に画像参照が残り、容量不足時は安全に数値保存へフォールバックできる
- テスト/検証：
  - ダミーで複数回保存して容量限界時の挙動（例外/メッセージ）を確認
- 依存関係・注意点：
  - Google Sheets には画像を保存しない前提（保存するのはローカルのみ）
- リスクと回避策：
  - リスク：localStorage で即上限到達
  - 回避：永続保存は IndexedDB に寄せる／保存はOFFが基本

---

## Step5: テスト/デバッグ（実機中心）
### Plan 6: 主要シナリオテストと不具合潰し込み
- 目的：
  - 実際の利用導線（撮影→参照→入力→保存）を安定させ、Phase 3（OCR）へ進める足場にする。
- 作業内容（チェックリスト）：
  - [ ] 実機（Android Chrome）での基本シナリオ
    - 撮影→使用→画像表示→入力→保存→クリア
  - [ ] エッジケース
    - 撮影後に削除してから入力
    - 画像を拡大表示したまま戻る/回転/スリープ復帰
    - 連続撮影（再撮影を複数回）
  - [ ] パフォーマンス/メモリ
    - 連続操作で極端に重くならない
    - 画像破棄後に操作が軽いまま
  - [ ] 既存機能への回帰
    - 画像なしでも従来通り入力・保存・一覧・グラフが動く
- 変更対象（想定ファイル/モジュール）：
  - 不具合内容に応じて `js/app.js` / `js/camera.js` / `css/style.css`
- 受け入れ基準（完了条件）：
  - 上記主要シナリオを通して、致命的なUI崩れ・保存失敗・戻れない状態がない
- テスト/検証：
  - DevTools の Console エラーが出ない
  - Network オフ時でもローカル保存ができる（Phase 1の仕様が維持される）
- 依存関係・注意点：
  - HTTPSでのカメラ要件は既知（テスト環境のURLに注意）
- リスクと回避策：
  - リスク：端末差で画像向き/拡大が崩れる
  - 回避：複数端末/複数ブラウザで最小限チェック、問題が出たら表示用CSS/変換処理を調整

