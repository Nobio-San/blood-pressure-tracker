## 前提・要約
- 目的：PWA（Android）上でスマホカメラにアクセスし、プレビュー表示と静止画キャプチャ（canvas取得）までを実装する。
- 成果物：`js/camera.js`（カメラ制御モジュール）、カメラ起動/プレビュー用UI（ボタン+モーダル）、基本的なエラーハンドリング。
- 対象の種類（推定）：機能追加（Phase 2の新規実装）。
- 成功条件（Done）：
  - HTTPS（またはlocalhost）環境で「カメラで撮影」→プレビュー表示→「シャッター」で画像データを取得できる
  - 「閉じる」でストリームが停止し、カメラが解放される
  - 権限拒否/非対応/HTTPアクセス時にユーザーへ分かるエラー表示が出る
- 前提（仮定した点があれば明記）：
  - ターゲットは Android Chrome（PWA）を主対象とする
  - 既存の `index.html` / `css/style.css` / `js/app.js` は Phase 1 まで完了している
  - Step 2-2（撮影画像プレビュー）は別ステップで実装するため、Step 2-1 では「画像データ取得」と「イベント通知/保持」までに留める
- 主要な制約：
  - カメラはセキュアコンテキスト（HTTPS/localhost）かつユーザー操作（クリック等）からの起動が必要
  - 端末差異（背面カメラ指定の可否、複数カメラ、権限UI）を考慮する
- 既知の不明点（あれば）：
  - 本番ホスティング先（HTTPS提供の有無）
  - UI配置（フォームのどこに撮影ボタンを置くか）の最終デザイン

## 全体ステップ構成
- Step2-1: カメラアクセス機能実装（起動/停止/キャプチャ・UI基盤）
- Step2-2: 撮影画像のプレビュー機能（再撮影/採用/リサイズ/向き補正）
- Step2-3: 撮影ガイド機能（オーバーレイ枠/ヒント）
- Step2-4: 画像から手動入力への連携（入力画面への画像表示）
- Step2-5: テストとデバッグ（端末/環境差の吸収）

---

## Step2-1: カメラアクセス機能実装
### Plan 1: UIスケルトン（ボタン・モーダル・プレビュー領域）
- 目的：ユーザーが「カメラで撮影」を起点に、モーダル内でプレビューと操作ができるUI基盤を用意する。
- 作業内容（チェックリスト）：
  - [ ] `index.html` に「カメラで撮影」ボタンを追加（既存フォームの上部 or 入力セクション上部）
  - [ ] モーダル要素を追加（表示/非表示切替ができる構造）
  - [ ] モーダル内に `video`（プレビュー）・`canvas`（キャプチャ用、非表示可）を配置
  - [ ] 操作ボタンを配置（シャッター/閉じる）
  - [ ] エラー/注意表示の領域（テキスト）を用意
  - [ ] アクセシビリティ最小対応（`aria-label`、フォーカス移動、Escで閉じるは任意）
- 変更対象（想定ファイル/モジュール）：
  - `index.html`
- 受け入れ基準（完了条件）：
  - ボタン押下でモーダルが開閉できる（JSは仮でもOK）
  - モーダル内にプレビュー/操作UIが崩れず表示される
- テスト/検証：
  - PCブラウザ/Androidでレイアウト確認（レスポンシブ）
- 依存関係・注意点：
  - モーダル表示の実装は `camera.js` 側へ寄せても良いが、DOMのID/クラス命名を先に固定する
- リスクと回避策：
  - リスク：端末の画面サイズで操作ボタンが押しづらい
  - 回避策：ボタンを大きめ（48px以上）・下部固定寄りに配置

### Plan 2: `camera.js` の土台（起動/停止の責務分離）
- 目的：カメラ起動〜停止までの基本制御をモジュール化し、UI層（`app.js`）から呼べる形にする。
- 作業内容（チェックリスト）：
  - [ ] `js/camera.js` を新規作成
  - [ ] 内部状態を定義（`stream` / `videoEl` / 起動中フラグ 等）
  - [ ] セキュアコンテキスト判定（HTTPS/localhost以外は警告を返す）
  - [ ] `startCamera()` を実装
    - [ ] `navigator.mediaDevices.getUserMedia` を使用
    - [ ] `facingMode: { ideal: 'environment' }` で背面優先（失敗時はフォールバック）
    - [ ] 取得した `stream` を `video.srcObject` に設定し再生
  - [ ] `stopCamera()` を実装
    - [ ] 全trackを `stop()` し `srcObject` をクリア
    - [ ] 参照を破棄してメモリリークを防止
  - [ ] 例外を分類してUIへ返す（`NotAllowedError` / `NotFoundError` / `NotReadableError` / `OverconstrainedError` 等）
- 変更対象（想定ファイル/モジュール）：
  - `js/camera.js`
- 受け入れ基準（完了条件）：
  - start→stop を繰り返してもクラッシュせず、カメラが解放される（他アプリがカメラを使える状態になる）
  - 失敗時に「原因カテゴリ」を返せる（メッセージ生成は次Planでも可）
- テスト/検証：
  - 権限許可/拒否を切り替えて挙動確認
  - stop後に再度startできること
- 依存関係・注意点：
  - `enumerateDevices()` は権限許可前だと詳細が取れない場合があるため、Step2-1では必須にしない
- リスクと回避策：
  - リスク：背面指定が効かない端末
  - 回避策：Overconstrained などは汎用constraintsで再試行する

### Plan 3: キャプチャ（video→canvas）とデータ受け渡しインターフェース
- 目的：シャッター操作で静止画を取得し、次ステップ（プレビュー/保存）へ渡せる形式で返す。
- 作業内容（チェックリスト）：
  - [ ] `capturePhoto()` を実装
    - [ ] `video` の表示サイズに合わせて `canvas` に描画
    - [ ] 画像データを `dataURL` もしくは `Blob` として取得（どちらかに統一）
    - [ ] 取得時に簡易のサイズ制御（例：最大幅/高さを超える場合に縮小。詳細最適化は Step2-2 へ）
  - [ ] 取得結果をアプリ側へ通知する仕組みを用意
    - [ ] 例：CustomEvent（`camera:captured`）で `detail` に画像データを載せる
    - [ ] もしくは `camera.js` がコールバック登録を受け付ける
  - [ ] シャッター連打を防ぐ（キャプチャ中はボタン無効化）
- 変更対象（想定ファイル/モジュール）：
  - `js/camera.js`
  - `index.html`（canvas要素が未配置なら）
- 受け入れ基準（完了条件）：
  - シャッター押下で画像データが生成され、コンソール確認またはイベント受信で内容が取れる
- テスト/検証：
  - 明るい場所/暗い場所で撮影し、画像データが空でないことを確認
- 依存関係・注意点：
  - 向き補正（EXIF）は Step2-2 で対応予定。Step2-1は「まず取れる」ことを優先
- リスクと回避策：
  - リスク：端末により `videoWidth/videoHeight` が 0 の瞬間がある
  - 回避策：`loadedmetadata`/`canplay` を待ってからキャプチャ可能にする

### Plan 4: UI配線（モーダル開閉・起動中表示・エラー表示）
- 目的：実際のユーザー操作で「起動→撮影→終了」まで通せる最小フローを完成させる。
- 作業内容（チェックリスト）：
  - [ ] `index.html` で `camera.js` を読み込む（スクリプト追加）
  - [ ] 「カメラで撮影」クリックでモーダルを開き `startCamera()` を呼ぶ
  - [ ] 起動中（Permission待ち含む）のローディング表示・ボタン無効化
  - [ ] 「閉じる」で `stopCamera()`→モーダル非表示
  - [ ] 「シャッター」で `capturePhoto()`→（一旦）成功メッセージ or イベント通知
  - [ ] エラー時はモーダル内にユーザー向けメッセージを表示
    - [ ] 権限拒否：ブラウザ設定で許可する案内
    - [ ] 非対応：対応ブラウザの案内
    - [ ] HTTP：HTTPSで開く案内
- 変更対象（想定ファイル/モジュール）：
  - `index.html`
  - `js/app.js`（イベントハンドリングを `app.js` に寄せる場合）
  - `css/style.css`
- 受け入れ基準（完了条件）：
  - Android Chromeで「カメラで撮影」→プレビューが表示される
  - 「閉じる」でプレビューが消え、カメラが停止している
  - 権限拒否時にユーザーが次アクションを理解できる表示が出る
- テスト/検証：
  - 権限：初回許可、拒否、拒否後に設定変更
  - 画面回転（縦/横）時も操作不能にならない
- 依存関係・注意点：
  - `app.js` 既存のフォーム送信などとイベント名/IDが衝突しないようにする
- リスクと回避策：
  - リスク：モーダル閉じ忘れでカメラが掴みっぱなし
  - 回避策：`visibilitychange`/`pagehide` でも `stopCamera()` を呼ぶ

### Plan 5: 最小テスト設計（端末差・例外系の洗い出し）
- 目的：Step2-1の段階で詰まりやすい「権限・端末差・解放漏れ」を早期に潰す。
- 作業内容（チェックリスト）：
  - [ ] 手動テストケース表を README またはメモとして作成
    - [ ] HTTPS / localhost / HTTP
    - [ ] 権限：許可 / 拒否 / 既に拒否状態
    - [ ] カメラなし（エミュレータ等）
    - [ ] 連続起動（start→stop→start）
    - [ ] アプリ切替（バックグラウンド→復帰）
  - [ ] 重要ログの追加（開始/停止/例外種別）※本番では抑制できる形
  - [ ] 既知制約をドキュメント化（例：HTTPS必須、初回は許可ダイアログ待ちなど）
- 変更対象（想定ファイル/モジュール）：
  - `README.md`（任意）
  - `js/camera.js`（ログ追加）
- 受け入れ基準（完了条件）：
  - テストケースを一通り実施し、重大な未解決バグ（起動不能・停止不能）が残っていない
- テスト/検証：
  - 実機（可能なら2端末）で確認
- 依存関係・注意点：
  - Step2-2以降で画像周り（向き・圧縮・プレビュー）を拡張する前提で、Step2-1は「安定した起動/停止」を最優先にする
- リスクと回避策：
  - リスク：端末固有の例外（NotReadableError等）で起動できない
  - 回避策：再試行ボタン/ガイダンスを出せるようにエラー分類を維持する

