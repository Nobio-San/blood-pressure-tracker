## 前提・要約
- 目的：血圧記録アプリのグラフ機能を「期間選択・グラフ種類切替・統計表示・目標ライン・時間帯/曜日分析」まで拡張し、日常的な振り返りと傾向把握をしやすくする。
- 成果物：
  - 期間/グラフ種別のUI（7/30/90/全期間、折れ線/棒/散布図）
  - 統計情報カード（平均・最大/最小・標準偏差・測定回数）
  - 目標ライン（設定/保存/表示）
  - 時間帯別（朝/昼/夜）・曜日別の可視化（切替表示）
  - Chart.js表示品質改善（ツールチップ/凡例/グリッド/アニメーション）
- 対象の種類（推定）：**改修 + 機能追加**（既存のChart.jsグラフ表示（Step 1-8）を拡張するため）
- 成功条件（Done）：
  - 期間選択・グラフ種別切替がモバイルで迷わず操作でき、選択に応じてグラフが即時更新される
  - 統計値が選択期間・選択メンバーに正しく追随し、算出根拠が一貫している
  - 目標ラインが任意に設定/保存でき、グラフ上で見やすく表示される
  - 時間帯別/曜日別のビューが破綻なく表示され、データが少ない場合も崩れずに説明表示される
  - 主要ブラウザ（Android Chrome中心）でエラーなく動作し、既存機能（記録・保存・フィルター）を壊さない
- 前提（仮定した点があれば明記）：
  - 既存実装に「グラフ描画関数（例：renderChart）」と「フィルタ済みレコード配列」が存在し、そこへオプションを追加する形で拡張する
  - レコード構造は `{ id, member, systolic, diastolic, pulse, datetime(ISO) }` 相当で統一されている
  - 同日複数測定の扱いは「日次集計（平均）」をデフォルトとし、散布図は「生データ（測定単位）」を表示する
  - 時間帯分類は暫定で **朝=4-10時 / 昼=11-16時 / 夜=17-3時**（ローカル時刻）
- 主要な制約：
  - PWA（モバイルファースト）での可読性・操作性優先
  - 依存ライブラリは原則 Chart.js（既存）に限定（追加プラグインは最小）
  - データ件数が増えても描画が極端に遅くならない（集計・間引きの方針を持つ）
- 既知の不明点（あれば）：
  - 目標血圧値の初期値（ユーザーが一般値を望むか、空で開始するか）
  - 時間帯の境界（家庭の生活リズムに合わせたい可能性）
  - 既存グラフのデータ整形方針（日次平均/最新/中央値など）

## 全体ステップ構成
- Step1: 既存グラフ実装の棚卸しと拡張ポイントの設計（破壊的変更を避ける）
- Step2: 期間選択 UI とフィルタリングロジックの実装
- Step3: グラフ種類（折れ線/棒/散布図）切替とデータ整形の実装
- Step4: 統計情報カード（平均・最小/最大・標準偏差・回数）の実装
- Step5: 目標ライン（設定/保存/表示）の実装
- Step6: 時間帯別/曜日別ビューの実装
- Step7: Chart.js オプション強化（UX改善）
- Step8: 回帰テスト・パフォーマンス・アクセシビリティ調整

---

## Step1: 既存グラフ実装の棚卸しと拡張設計
### Plan 1: グラフ描画の責務分離（データ整形 / チャート設定 / 描画）
- 目的：機能追加で `app.js` が肥大化・壊れやすくなるのを防ぎ、拡張可能な構造に整える。
- 作業内容（チェックリスト）：
  - [ ] 現状の「データ取得→フィルタ→整形→Chart.js描画」フローを読み解き、処理順をメモ化する
  - [ ] 「入力データ（record）」「表示用データ（series）」の境界を明確化する（関数名/戻り値の合意）
  - [ ] チャート更新（destroy→new / update）方式を確認し、メモリリークしない更新方針を決める
  - [ ] 今回追加する表示モード（期間・種別・分析）に必要なデータ形状を一覧化する
- 変更対象（想定ファイル/モジュール）：
  - `js/app.js`（既存グラフ関連関数）
- 受け入れ基準（完了条件）：
  - グラフ描画に関わる関数の入出力が整理され、追加機能の差し込みポイントが明確になっている（READMEメモでも可）
- テスト/検証：
  - 既存の「7日推移グラフ」が従来通り表示されること
- 依存関係・注意点：
  - 既存のメンバーフィルター（全員/個人）との整合を維持
- リスクと回避策：
  - リスク：リファクタで既存動作が壊れる
  - 回避策：このPlanでは**挙動変更しない**（関数抽出/名前整理に限定）

### Plan 2: UI追加エリアの配置設計（操作の迷いを減らす）
- 目的：モバイル画面でも「期間・種別・分析」の操作が過密にならないレイアウトを決める。
- 作業内容（チェックリスト）：
  - [ ] グラフカード内に「コントロール行（期間/種別/分析切替）」を置く配置案を作る
  - [ ] 操作頻度の高い順（期間→種別→分析）で並べ、表示幅が狭い場合は折り返し/2段を許容
  - [ ] データが少ない時の空状態（empty state）文言と表示位置を決める
- 変更対象（想定ファイル/モジュール）：
  - `index.html`（グラフエリア周辺）
  - `css/style.css`（コントロールのレスポンシブ）
- 受け入れ基準（完了条件）：
  - 360px幅相当でもコントロールが押しづらくならず、ラベルが判読できる
- テスト/検証：
  - Chrome DevToolsのモバイルエミュレーションで表示確認
- 依存関係・注意点：
  - Phase 4-1（デザイン洗練）と競合しうるため、クラス命名は汎用的に
- リスクと回避策：
  - リスク：UIが増えて“どこを触ればいいか”が分かりにくい
  - 回避策：デフォルト値を明示し、選択中の状態を強調（chip/segmented風）

---

## Step2: 期間選択 UI とフィルタリング
### Plan 1: 期間選択（7/30/90/全期間）のUI実装
- 目的：ユーザーが振り返り期間をワンタップで切り替えられるようにする。
- 作業内容（チェックリスト）：
  - [ ] セレクトボックスまたはセグメントボタンで期間選択UIを追加
  - [ ] 選択状態を `localStorage` に保存し、再起動後も復元
  - [ ] 期間変更時にグラフと統計が即時更新されるイベント配線
- 変更対象（想定ファイル/モジュール）：
  - `index.html`（期間選択UI）
  - `js/app.js`（状態管理、イベント）
- 受け入れ基準（完了条件）：
  - 4種の期間が選べ、選択後に表示が切り替わる（ページリロード不要）
- テスト/検証：
  - 期間ごとに件数が変化し、X軸範囲が意図通りに変わる
- 依存関係・注意点：
  - 「全期間」が長大になる場合の描画負荷（後続Stepで対策）
- リスクと回避策：
  - リスク：期間計算の境界（今日含む/含まない）で混乱
  - 回避策：基準を「現在日時からN日遡る（当日含む）」で統一し、UI説明に小さく表示

### Plan 2: フィルタリングロジック（メンバー×期間）の統一
- 目的：グラフ・統計・分析が同じフィルタ結果を共有し、ズレを防ぐ。
- 作業内容（チェックリスト）：
  - [ ] `getFilteredRecords({member, range})` のような共通関数を用意
  - [ ] datetimeのパースとタイムゾーン（ローカル）の扱いを統一
  - [ ] 期間内データが0件の場合の表示（グラフ非表示＋説明）を実装
- 変更対象（想定ファイル/モジュール）：
  - `js/app.js`
- 受け入れ基準（完了条件）：
  - 同一条件で「グラフ」「統計」「分析」の件数が一致する
- テスト/検証：
  - 手動で特定日のデータを作って境界日（7日前など）を確認
- 依存関係・注意点：
  - Google Sheetsから取得するデータとローカルのデータが混在する場合は「表示用の単一配列」に正規化してからフィルタ
- リスクと回避策：
  - リスク：日付フォーマット揺れで除外漏れ
  - 回避策：ISOに寄せたパース処理＋パース失敗ログを追加（デバッグ用）

---

## Step3: グラフ種類切替（折れ線/棒/散布図）
### Plan 1: グラフ種類切替UIと状態管理
- 目的：用途に応じて表現を切り替えられるようにする。
- 作業内容（チェックリスト）：
  - [ ] グラフ種類（line/bar/scatter）切替UIを追加
  - [ ] 選択値を `localStorage` に保存・復元
  - [ ] 種類変更時にChart.jsインスタンスを安全に再生成またはupdate
- 変更対象（想定ファイル/モジュール）：
  - `index.html`（種類切替UI）
  - `js/app.js`（状態、描画分岐）
- 受け入れ基準（完了条件）：
  - 3種類に切替でき、表示が破綻しない
- テスト/検証：
  - 期間×種類×メンバーの組合せで最低1回ずつ切替テスト
- 依存関係・注意点：
  - 散布図は「生データ」を使うため日次平均と混同しない
- リスクと回避策：
  - リスク：切替のたびにチャートが増殖
  - 回避策：destroyの徹底、canvas再利用、参照の単一化

### Plan 2: データ整形（line/barは日次集計、scatterは測定時刻分布）
- 目的：グラフ種別ごとに最適なデータ形状を作る。
- 作業内容（チェックリスト）：
  - [ ] line/bar用：日付でグルーピングして平均（sys/dia/pulse）を算出
  - [ ] scatter用：X軸=時刻（0-24hまたは日時）、Y軸=血圧（sys/dia）を点で表示
  - [ ] データが少ない場合の間引き不要判定（閾値を用意）
  - [ ] 並び順（昇順）とラベル生成（MM/DDなど）を統一
- 変更対象（想定ファイル/モジュール）：
  - `js/app.js`（データ整形ユーティリティ）
- 受け入れ基準（完了条件）：
  - 各種別で意図したX/Yが表示され、ツールチップに日時/値が出る
- テスト/検証：
  - 同日複数データの時、line/barは平均、scatterは点が複数出ること
- 依存関係・注意点：
  - pulseをscatterに含めるかは情報量過多になりがちなので、まずはsys/diaを優先（必要ならトグル追加）
- リスクと回避策：
  - リスク：散布図が見づらい（点が重なる）
  - 回避策：点の半透明化・半径調整・ツールチップ重視

---

## Step4: 統計情報カードの実装
### Plan 1: 統計算出ロジック（平均/最小/最大/標準偏差/回数）
- 目的：選択条件に対する基本統計を正確に表示する。
- 作業内容（チェックリスト）：
  - [ ] フィルタ済みレコードから sys/dia/pulse の配列を作る
  - [ ] 平均・最小・最大・標準偏差（母/標本はどちらかに統一）・測定回数を算出
  - [ ] 欠損値（null/NaN）の除外方針を統一
  - [ ] 表示用に小数処理（整数丸め）ルールを定義
- 変更対象（想定ファイル/モジュール）：
  - `js/app.js`
- 受け入れ基準（完了条件）：
  - 既知のサンプルデータで手計算と一致する
- テスト/検証：
  - 3〜5件の固定データを用意し、平均/標準偏差が一致することを確認
- 依存関係・注意点：
  - 標準偏差の定義（母標準偏差/標本標準偏差）をUI注記に入れるか検討（まずは母標準偏差で簡便に）
- リスクと回避策：
  - リスク：統計が難しく感じられる
  - 回避策：まずは「平均・最小/最大・回数」を強調し、標準偏差は小さめ表示

### Plan 2: 統計表示UI（カード/表）と更新連動
- 目的：グラフの下に“ひと目で分かる”指標を提示する。
- 作業内容（チェックリスト）：
  - [ ] sys/dia/pulseごとにカードを用意（平均・最小/最大・標準偏差）
  - [ ] 測定回数を共通で表示（例：選択期間内 n=xx）
  - [ ] フィルタ条件変更（メンバー/期間/種別）に追随して再描画
  - [ ] 0件時はカードを非表示にしてメッセージ表示
- 変更対象（想定ファイル/モジュール）：
  - `index.html`（統計表示領域）
  - `css/style.css`（カードレイアウト）
  - `js/app.js`（描画/更新）
- 受け入れ基準（完了条件）：
  - 期間を切り替えると統計値が即座に変わり、誤った値が残らない
- テスト/検証：
  - フィルタ変更の連打でもUIが崩れない（状態が一貫）
- 依存関係・注意点：
  - Phase 4-1のカードデザインと統一
- リスクと回避策：
  - リスク：情報過多
  - 回避策：初期は折りたたみ（“詳細”）も検討（必要なら後続改善）

---

## Step5: 目標ライン（設定/保存/表示）
### Plan 1: 目標値設定UI（収縮期/拡張期）と保存
- 目的：自分の目標（または医師の指示）に合わせて基準線を引けるようにする。
- 作業内容（チェックリスト）：
  - [ ] 目標値入力（sys/dia）UIを追加（数値、範囲チェック）
  - [ ] ON/OFFトグル（表示する/しない）を用意
  - [ ] `localStorage` に保存し、起動時に復元
  - [ ] 不正値時のエラーメッセージ（例：sys < dia 等）
- 変更対象（想定ファイル/モジュール）：
  - `index.html`（目標設定UI）
  - `js/app.js`（設定状態、保存）
- 受け入れ基準（完了条件）：
  - 目標値が保存され、ページ再読み込み後も維持される
- テスト/検証：
  - 入力範囲外や sys<=dia の場合に保存されないこと
- 依存関係・注意点：
  - 将来的に通知機能（Step 4-4）で目標超過判定に使えるようキー名を整理
- リスクと回避策：
  - リスク：ユーザーが一般的な基準を期待
  - 回避策：初期値は空（OFF）にし、「医師の指示がある場合に設定」と注記

### Plan 2: Chart.jsへの目標ライン反映（annotation相当の実装）
- 目的：目標をグラフ上で直感的に比較できるようにする。
- 作業内容（チェックリスト）：
  - [ ] line/barで、目標値を「水平線データセット」として追加（破線・薄色）
  - [ ] ツールチップや凡例で“目標(最高/最低)”と識別できるようにする
  - [ ] 散布図では視認性が落ちる場合、表示をデフォルトOFF or 薄くする
- 変更対象（想定ファイル/モジュール）：
  - `js/app.js`（chart datasets生成）
- 受け入れ基準（完了条件）：
  - 目標表示ONで、水平線がズレずに表示される（Y軸スケール変更でも追随）
- テスト/検証：
  - 目標値を変えると即座にラインが移動する
- 依存関係・注意点：
  - Chart.jsプラグイン（annotation）導入は極力避け、まずは標準データセットで実現
- リスクと回避策：
  - リスク：データセットが増えて凡例が煩雑
  - 回避策：凡例をフィルタし、目標は小さく/下段に配置、または凡例クリックで非表示可能に

---

## Step6: 時間帯別/曜日別ビュー
### Plan 1: 時間帯別（朝/昼/夜）集計と表示
- 目的：生活リズムに沿った傾向（朝高い等）を把握できるようにする。
- 作業内容（チェックリスト）：
  - [ ] 時間帯分類関数を実装（ローカル時刻で分類）
  - [ ] 時間帯ごとに平均（sys/dia/pulse）と回数を算出
  - [ ] 表示は棒グラフ（カテゴリ軸：朝/昼/夜）を基本にする
  - [ ] データ不足時（各カテゴリn<2など）の注意表示
- 変更対象（想定ファイル/モジュール）：
  - `js/app.js`（集計）
  - `index.html`（分析ビュー切替UI、補助テキスト）
- 受け入れ基準（完了条件）：
  - 期間/メンバー変更に追随し、朝/昼/夜の平均が更新される
- テスト/検証：
  - 意図的に朝だけ/夜だけのデータを入れて正しくカテゴリに入ること
- 依存関係・注意点：
  - 時間帯定義は将来設定化できるように定数化
- リスクと回避策：
  - リスク：分類境界が家庭によって違う
  - 回避策：定数化し、必要なら設定UIを後続タスクに切り出せる構造に

### Plan 2: 曜日別集計と表示（週次傾向）
- 目的：曜日単位の生活パターン（週末の変化等）を把握する。
- 作業内容（チェックリスト）：
  - [ ] 曜日（Mon..Sun / 日本語表記）に分類
  - [ ] 曜日ごとの平均と回数を算出
  - [ ] 表示は棒グラフ（カテゴリ軸：月〜日）を基本にする
  - [ ] 表示順の固定（必ず月→日）
- 変更対象（想定ファイル/モジュール）：
  - `js/app.js`
- 受け入れ基準（完了条件）：
  - 曜日別の並びが崩れず、データが無い曜日は0/空として扱える
- テスト/検証：
  - 特定曜日だけ入力して、他曜日が欠けてもエラーにならないこと
- 依存関係・注意点：
  - i18nはしない前提で、日本語ラベル固定
- リスクと回避策：
  - リスク：表示モードが増え切替が複雑
  - 回避策：分析タブ（「推移」「時間帯」「曜日」）のように“目的別”に整理

### Plan 3: 分析ビュー切替（推移/時間帯/曜日）と空状態
- 目的：ユーザーが迷わず“見たい分析”に到達できるようにする。
- 作業内容（チェックリスト）：
  - [ ] ビュー切替UI（タブ/セグメント）を追加
  - [ ] 各ビューの説明文（何が分かるか）を短く表示
  - [ ] 0件/少数件の空状態（例："分析には3件以上が必要"）を整備
- 変更対象（想定ファイル/モジュール）：
  - `index.html`, `css/style.css`, `js/app.js`
- 受け入れ基準（完了条件）：
  - どのビューでも“真っ白”にならず、次の行動が分かる文言が出る
- テスト/検証：
  - 新規インストール（0件）状態での表示確認
- 依存関係・注意点：
  - 種別切替（折れ線/棒/散布）とのUI競合を避ける（推移ビューのみで有効等の制約を入れて良い）
- リスクと回避策：
  - リスク：切替条件が複雑化
  - 回避策：有効な組合せをUI側で制限（無効化/非表示）

---

## Step7: Chart.js オプション強化（UX改善）
### Plan 1: ツールチップ/凡例/グリッドの改善
- 目的：値の読み取りやすさを上げる。
- 作業内容（チェックリスト）：
  - [ ] ツールチップに「日時・メンバー・sys/dia/pulse」を分かりやすく表示
  - [ ] 凡例の位置（上/下）をモバイルで邪魔にならない位置へ
  - [ ] グリッド線を薄くし、主目盛のみ強調（視認性向上）
  - [ ] 右Y軸（脈拍）を使うモードのラベルと色を統一
- 変更対象（想定ファイル/モジュール）：
  - `js/app.js`（Chart.js options）
- 受け入れ基準（完了条件）：
  - 主要端末でツールチップが画面外に飛び出しにくい
- テスト/検証：
  - 点が密な状態でもタップで値が確認できる
- 依存関係・注意点：
  - モバイルは hover ではなく tap が中心
- リスクと回避策：
  - リスク：オプション追加で複雑化
  - 回避策：options生成関数を分離し、モード別に上書き

### Plan 2: アニメーション/更新体験の調整
- 目的：期間や種類の切替で“気持ちよく”変化し、かつ遅くしない。
- 作業内容（チェックリスト）：
  - [ ] 初回表示は軽いアニメーション、連続切替時は短め/無効化（閾値）
  - [ ] 長期間（全期間）では点数が多い場合、アニメーションを抑制
  - [ ] ローディング/更新中インジケータ（短時間でも）を検討
- 変更対象（想定ファイル/モジュール）：
  - `js/app.js`
- 受け入れ基準（完了条件）：
  - 90日/全期間でも操作が重く感じにくい
- テスト/検証：
  - データ1000件程度を想定して切替が許容範囲か確認（生成データでも可）
- 依存関係・注意点：
  - PWAの低スペック端末でも動くこと
- リスクと回避策：
  - リスク：描画が重い
  - 回避策：集計（line/bar）中心、scatterは期間制限を入れるなど制御

---

## Step8: 回帰テスト・パフォーマンス・アクセシビリティ
### Plan 1: 回帰テスト（既存機能を壊していないことの確認）
- 目的：記録・保存・一覧・フィルター・OCR連携など、既存の主要フローを守る。
- 作業内容（チェックリスト）：
  - [ ] 記録追加→一覧更新→グラフ/統計更新が崩れない
  - [ ] 削除後にグラフ/統計が正しく再計算される
  - [ ] メンバー切替が全ビュー（推移/時間帯/曜日）に反映される
  - [ ] オフライン時（保存はローカル）でもグラフが表示できる
- 変更対象（想定ファイル/モジュール）：
  - 主に `js/app.js`
- 受け入れ基準（完了条件）：
  - 主要シナリオ（記録→確認→分析→切替）が一通り通る
- テスト/検証：
  - 手動シナリオテスト手順をREADMEにメモして再現可能にする
- 依存関係・注意点：
  - まだ未実装のPhase 4機能（通知/オフライン強化）とは独立に完結させる
- リスクと回避策：
  - リスク：状態管理が複雑でバグが出やすい
  - 回避策：状態（member/range/type/view/target）を1つのオブジェクトに集約

### Plan 2: パフォーマンス・アクセシビリティの調整
- 目的：データが増えても快適に使え、高齢者にも優しいUIにする。
- 作業内容（チェックリスト）：
  - [ ] 全期間などで描画点数が多い場合の間引き/集計優先を適用
  - [ ] 文字サイズ・コントラスト・タップ領域を確認（48px目安）
  - [ ] コントロールUIにラベル/aria属性を付与
  - [ ] 端末回転や画面サイズ変更でもレイアウトが崩れない
- 変更対象（想定ファイル/モジュール）：
  - `css/style.css`, `index.html`, `js/app.js`
- 受け入れ基準（完了条件）：
  - 体感でカクつきが少なく、操作が迷わない
- テスト/検証：
  - Lighthouseの簡易チェック（Performance/Accessibility）で重大な指摘が出ない
- 依存関係・注意点：
  - 画像/OCR処理と同時に重くならないよう、グラフ更新は必要時のみ
- リスクと回避策：
  - リスク：機能を増やしたことでUIが複雑
  - 回避策：デフォルトは「推移×折れ線×30日」など分かりやすい初期状態に固定

