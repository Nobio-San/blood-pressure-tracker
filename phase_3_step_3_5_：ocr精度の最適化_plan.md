## 前提・要約
- 目的：血圧計の撮影画像に対して、OCRの認識率と安定性を上げる（機種差・照明差・角度差に強くする）。
- 成果物：Step 3-5（OCR精度の最適化）をCursorで順番に実行できるPlan一式（実装/検証/計測/デバッグ導線含む）。 fileciteturn0file0
- 対象の種類（推定）：改修（OCR処理の最適化）＋計測/デバッグ機能追加（品質改善）。
- 成功条件（Done）：
  - 複数の前処理パターン＋PSM複数試行により、最良候補を選べる。
  - 認識結果の後処理（誤読補正・妥当性チェック）で誤入力を減らせる。
  - デバッグモードで「前処理画像・rawText・各試行のconfidence/抽出結果」を確認できる。
  - 代表的なテスト画像セットで、認識成功率が改善していることを計測で示せる（改善率/基準は後述の仮定）。
- 前提（仮定した点があれば明記）：
  - OCRはTesseract.js（jpn+eng）で、Step 3-1〜3-4が既に動作している前提。
  - 抽出対象は「最高/最低/脈拍」の3値で、入力フォームは既存（Step 3-4）。
  - 画像はStep 2-2で長辺1280px程度に最適化済み、向き補正済みを前提。
  - “成功率”の定義：3値のうち「最高/最低が正しい」または「3値すべて正しい」を指標として計測できるようにする（両方を出す）。
- 主要な制約：
  - AndroidのPWAで動作（計算量/メモリに上限）。
  - ネットワーク前提にしない（ローカルで完結、必要ならログをDL）。
  - 個人利用なのでクラウド学習/外部送信はしない。
- 既知の不明点（あれば）：
  - ユーザーが使う血圧計の表示レイアウト（SYS/DIA/PULの並び、区切り記号、フォント）がどれくらい多様か。
  - 最終的に狙う認識率（開発計画書ではPhase 3全体で80%目標）。 fileciteturn0file0

## 全体ステップ構成
- Step1: 計測・デバッグ土台の追加（改善ループを回せる状態にする）
- Step2: 前処理パイプラインの複数化とROI強化（入力画像品質を上げる）
- Step3: Tesseract設定の探索（PSM/パラメータを複数試行）
- Step4: 後処理・妥当性強化（誤読補正と候補選別の精度を上げる）
- Step5: パフォーマンス最適化とフォールバック設計（実利用で耐える）

---

## Step1: 計測・デバッグ土台の追加
### Plan 1: OCR試行結果の共通スキーマ化（ログ基盤）
- 目的：前処理/PSM/設定の違いによる結果比較を容易にし、改善の根拠を残す。
- 作業内容（チェックリスト）：
  - [ ] `recognizeText()`（またはOCR実行関数）の戻り値に「試行メタ情報」を持たせるスキーマを定義
  - [ ] 1回のOCR実行を「複数試行（attempts）」として扱い、attemptごとに以下を格納
    - preprocessパターン名
    - ROI情報（座標/倍率/回転など）
    - Tesseract設定（PSM、whitelistなど）
    - 認識結果（rawText、words/lines、confidence）
    - 抽出結果（systolic/diastolic/pulse候補、検証結果、スコア）
  - [ ] 最終採用結果（selectedAttemptId）と採用理由（スコア内訳）を格納
  - [ ] 例外/失敗（タイムアウト、ワーカーエラー）の分類コードを設計
- 変更対象（想定ファイル/モジュール）：
  - `js/ocr.js`
- 受け入れ基準（完了条件）：
  - OCR実行後に、attempt配列と最終採用結果が得られる（UIに表示しなくてもOK）。
  - 失敗時にも原因分類が戻る（ユーザー向け文言はStep 3-4側で表示）。
- テスト/検証：
  - 手元の1〜2枚の画像で、attemptが複数入り、selectedAttemptIdがセットされることをconsoleで確認。
- 依存関係・注意点：
  - Step 3-3の抽出ロジックをattempt単位で呼べるように整理が必要。
- リスクと回避策：
  - リスク：ログが肥大化しメモリ/速度を悪化。
  - 回避：rawText/詳細情報はデバッグ時のみ保持（Plan 2でフラグ導入）。

### Plan 2: デバッグモード（前処理画像/詳細ログの表示切替）
- 目的：実機で精度問題が起きた時に、原因（前処理/ROI/誤読）を即座に特定できるようにする。
- 作業内容（チェックリスト）：
  - [ ] `OCR_DEBUG`フラグ（URLクエリ `?debug=1` or localStorage）を追加
  - [ ] デバッグ時のみ以下をUIまたは開発者ツールに出力
    - 前処理後canvas画像（縮小サムネ）
    - rawText
    - attemptsのスコア一覧（採用/不採用理由）
  - [ ] デバッグOFF時は、詳細ログ生成を抑制（必要最小限）
- 変更対象（想定ファイル/モジュール）：
  - `js/ocr.js`
  - （必要なら）`index.html`, `css/style.css`（デバッグ表示領域を追加する場合のみ）
- 受け入れ基準（完了条件）：
  - debug=1 の時のみ、前処理画像とattempt一覧が確認できる。
  - debug=0 の時に、UIが増えず、処理コストも増えない。
- テスト/検証：
  - debugのON/OFFで表示とログ量が変わることを確認。
- 依存関係・注意点：
  - Step 3-4のUIに干渉しないよう、表示は折りたたみ/モーダル推奨。
- リスクと回避策：
  - リスク：ユーザー（家族）にデバッグが露出。
  - 回避：フラグ無しでは一切表示しない／UIは「開発用」表記。

---

## Step2: 前処理パイプラインの複数化とROI強化
### Plan 1: 前処理パターンのモジュール化（A/B/Cの試行フレーム）
- 目的：開発計画書で示された「複数前処理パターンを試行し最良を採用」を、拡張しやすい形で実装する。 fileciteturn0file0
- 作業内容（チェックリスト）：
  - [ ] `preprocessImage()`を「パターン定義（配列）」で回せる構造に変更
  - [ ] 最低限の3パターンを定義
    - [ ] パターンA：グレースケール＋単純二値化
    - [ ] パターンB：コントラスト強調＋二値化（閾値調整幅あり）
    - [ ] パターンC：エッジ強調（例：アンシャープマスク相当）＋二値化
  - [ ] 各パターンのパラメータ（閾値、コントラスト係数）を設定可能に
  - [ ] 前処理の出力は「canvas」＋メタ情報（サイズ/閾値等）で返す
- 変更対象（想定ファイル/モジュール）：
  - `js/ocr.js`
- 受け入れ基準（完了条件）：
  - 1枚の画像に対して、A/B/Cそれぞれの前処理結果でOCRが走り、attemptとして記録される。
- テスト/検証：
  - デバッグモードで前処理後のサムネが3種類出る。
- 依存関係・注意点：
  - Canvas処理は端末依存で重くなるため、画像サイズを段階的に落とす導線を残す（Plan 3）。
- リスクと回避策：
  - リスク：試行数増で遅い。
  - 回避：後続Stepで早期打ち切り/優先順位付け（スコアが高い時は打ち切る）。

### Plan 2: ROI（切り抜き）強化：ガイド枠→自動微調整
- 目的：文字以外の領域を除外し、認識対象を絞ることで精度と速度を同時に改善する。
- 作業内容（チェックリスト）：
  - [ ] 既存のガイド枠（Step 2-3想定）に基づくROI切り抜きを前提に整理
  - [ ] ROI内で「数字密度が高い領域」を探索する簡易自動補正を追加
    - 例：二値化後の水平投影/垂直投影で文字列が存在する帯を推定
  - [ ] ROIを複数候補（例：±5〜10%のマージン違い）で試行できるように（attempt増）
- 変更対象（想定ファイル/モジュール）：
  - `js/ocr.js`
- 受け入れ基準（完了条件）：
  - ROIを微調整したattemptが生成され、元ROIより高スコアになるケースが確認できる。
- テスト/検検証：
  - 斜め撮影/余白多めの画像で、ROI補正ありの方が安定することを確認。
- 依存関係・注意点：
  - 探索幅を広げすぎると遅くなるので、候補数に上限を設ける。
- リスクと回避策：
  - リスク：誤ったROIに寄って精度が落ちる。
  - 回避：元ROIも必ず残し、スコア比較で採用。

### Plan 3: 前処理の解像度戦略（速度と精度のトレードオフ制御）
- 目的：端末性能差でも体感速度を維持しつつ、精度が必要な時だけ重い処理を行う。
- 作業内容（チェックリスト）：
  - [ ] OCR入力canvasの最大辺を複数段階（例：640/960/1280）で切替可能に
  - [ ] まず低解像度＋軽い前処理で試行し、スコアが閾値未満の時だけ高解像度/重い前処理へフォールバック
  - [ ] attemptに「解像度段階」を記録
- 変更対象（想定ファイル/モジュール）：
  - `js/ocr.js`
- 受け入れ基準（完了条件）：
  - 低解像度で十分な画像は早期に確定し、処理時間が短縮される。
- テスト/検証：
  - 2種類の画像（鮮明/不鮮明）で、鮮明は早期確定、不鮮明は段階アップすることをログで確認。
- 依存関係・注意点：
  - 早期確定の閾値はStep4のスコアリング設計と合わせる。
- リスクと回避策：
  - リスク：閾値設定ミスで精度が落ちる。
  - 回避：デバッグモードで閾値とスコアを可視化し、テスト画像で調整。

---

## Step3: Tesseract設定の探索（PSM/パラメータを複数試行）
### Plan 1: PSMの複数試行（6/7/8）とベスト選択
- 目的：表示のレイアウト差（1行/ブロック/単語）に対応し、最良の認識を自動で選べるようにする。 fileciteturn0file0
- 作業内容（チェックリスト）：
  - [ ] PSM候補（6/7/8）を定義し、前処理パターン×PSMでattemptを生成
  - [ ] 途中で「十分高いスコア」に到達したら探索を打ち切る（最大試行数を制限）
  - [ ] PSMごとの特性（rawTextの形）をログで比較できるように
- 変更対象（想定ファイル/モジュール）：
  - `js/ocr.js`
- 受け入れ基準（完了条件）：
  - 同一画像でPSM違いのattemptが残り、最終選択がスコアで説明できる。
- テスト/検証：
  - 1行表示/複数行っぽい表示の両方で、PSMが切り替わって採用されるケースを確認。
- 依存関係・注意点：
  - 試行増で遅くなるため、Step2の解像度戦略とセット運用。
- リスクと回避策：
  - リスク：試行数爆発。
  - 回避：探索順序（軽いもの→重いもの）と早期打ち切り。

### Plan 2: Tesseractパラメータのチューニング（whitelist/禁止文字/辞書）
- 目的：数字認識に特化し、ノイズ文字を減らす。
- 作業内容（チェックリスト）：
  - [ ] `tessedit_char_whitelist` を「0123456789/」中心に整理（必要なら空白も許容）
  - [ ] `tessedit_char_blacklist` で頻出ノイズ（例：英字）を抑制（必要性をログで確認）
  - [ ] 数字のみ想定のため、可能なら言語を `eng` 優先にするモードも試す（jpn+engとの比較）
  - [ ] attemptに「言語モード」を記録
- 変更対象（想定ファイル/モジュール）：
  - `js/ocr.js`
- 受け入れ基準（完了条件）：
  - rawTextにノイズ文字が減り、抽出成功率が上がる（少なくともテスト画像で改善が見える）。
- テスト/検証：
  - 同一画像で言語/whitelist違いを比較し、スコア差を確認。
- 依存関係・注意点：
  - `jpn` を外すと「表示ラベル（SYS等）」の誤認識は増減するが、最終目的は数字抽出なので影響評価する。
- リスクと回避策：
  - リスク：機種によって区切り記号（／やスペース）が異なる。
  - 回避：後処理（Step4）で区切り記号の揺れに対応。

---

## Step4: 後処理・妥当性強化
### Plan 1: 文字誤読補正と正規化（O→0、I→1など）
- 目的：Tesseractが出すrawTextの揺れを吸収し、抽出ロジックの成功率を上げる。 fileciteturn0file0
- 作業内容（チェックリスト）：
  - [ ] rawTextに対して正規化処理（全角→半角、複数スペース圧縮）
  - [ ] 典型的誤読の置換ルールを導入（例：O/o→0、I/l→1、S→5 など）
  - [ ] 区切り記号の揺れ吸収（「/」「|」「-」「：」などをスラッシュ相当へ寄せる）
  - [ ] 置換前後のテキストをattemptに記録（デバッグ時のみ）
- 変更対象（想定ファイル/モジュール）：
  - `js/ocr.js`
- 受け入れ基準（完了条件）：
  - 置換により、抽出できなかったケースが抽出できる例が確認できる。
- テスト/検証：
  - 誤読が出た画像で、正規化前後の抽出結果が改善することを確認。
- 依存関係・注意点：
  - 置換は副作用があるため、範囲チェック（Plan 3）とセットで安全策を取る。
- リスクと回避策：
  - リスク：誤った置換で値が変わる。
  - 回避：値の妥当性（範囲/大小関係）とスコアリングで弾く。

### Plan 2: 候補抽出の強化（複数パターン・複数候補のスコアリング）
- 目的：単純な正規表現だけに依存せず、候補を複数出して最適を選ぶ。
- 作業内容（チェックリスト）：
  - [ ] 現行の「XXX/YYY」検出に加え、以下も候補化
    - [ ] 「XXX YYY」（区切りなし）
    - [ ] SYS/DIA/PULの近傍数字（ラベル近傍探索）
    - [ ] 2〜3桁数字の組み合わせを列挙し、範囲/関係でフィルタ
  - [ ] 候補ごとにスコアを付ける（例：
    - 範囲内 +20
    - 最高>最低 +20
    - 典型レンジ（例：80〜180等）への近さ +α
    - OCR word confidence平均 +α
    - 区切り形式が明確 +α
    ）
  - [ ] attemptの総合スコア = OCR信頼度 + 抽出スコア の合成（重み付け）
- 変更対象（想定ファイル/モジュール）：
  - `js/ocr.js`
- 受け入れ基準（完了条件）：
  - 複数候補が生成され、最終採用がスコアで説明できる。
- テスト/検証：
  - 似た数字が複数出るrawTextで、範囲/関係により正しい候補が選ばれる。
- 依存関係・注意点：
  - スコア設計は“過学習”しやすいので、テスト画像セットで評価しながら調整。
- リスクと回避策：
  - リスク：スコアが複雑化。
  - 回避：スコア内訳をattemptに持たせ、デバッグで可視化。

### Plan 3: 妥当性チェックの強化（安全側の失敗とUI連携）
- 目的：誤認識の自動入力を抑え、「自動入力する/しない」の判断を安全にする。
- 作業内容（チェックリスト）：
  - [ ] 既存の範囲チェック（SYS 50-250, DIA 30-150, PUL 40-200）を「厳格/緩和」の2段階に
  - [ ] “確信度”を「OCR confidence」だけでなく「抽出スコア」も加味した総合指標に変更
  - [ ] 総合指標が低い場合は、
    - [ ] 自動入力はするが赤表示（Step 3-4の設計）
    - [ ] もしくは自動入力を抑止して“要確認”にする（安全優先）
  - [ ] 選択ポリシーを定数化（閾値を一箇所で調整できる）
- 変更対象（想定ファイル/モジュール）：
  - `js/ocr.js`
  - （連携）`js/app.js`（自動入力/要確認の分岐を使う場合）
- 受け入れ基準（完了条件）：
  - 明らかに怪しい結果は「要確認」扱いになり、誤入力が減る。
- テスト/検証：
  - わざとブレた画像で、総合指標が下がり“要確認”に落ちることを確認。
- 依存関係・注意点：
  - Step 3-4のUI（信頼度色分け）と整合するよう、指標/閾値を共有する。
- リスクと回避策：
  - リスク：厳しすぎて自動入力がほぼ出ない。
  - 回避：閾値を段階的に調整し、計測（Step5）で最適点を探る。

---

## Step5: パフォーマンス最適化とフォールバック設計
### Plan 1: 探索戦略の最適化（試行順序・早期打ち切り・タイムアウト）
- 目的：最適化で試行数が増えても、実利用の待ち時間を許容範囲に収める。
- 作業内容（チェックリスト）：
  - [ ] 「軽い→重い」の探索順序を明文化（例：低解像度A×PSM7 → A×PSM6 → B…）
  - [ ] 早期打ち切り閾値（総合スコア）が一定以上で即決
  - [ ] 1回のOCR全体にタイムアウトを設定（例：8〜12秒）
  - [ ] タイムアウト時は現在のベスト候補を返す or “失敗”として手動入力を促す
- 変更対象（想定ファイル/モジュール）：
  - `js/ocr.js`
- 受け入れ基準（完了条件）：
  - 最悪ケースでもタイムアウトで戻る（無限待ちがない）。
  - 良条件では早期確定して高速。
- テスト/検証：
  - 端末の省電力モード等でも固まらず戻ることを確認。
- 依存関係・注意点：
  - タイムアウト値は端末差があるため、将来的に設定可能にしてもよい。
- リスクと回避策：
  - リスク：タイムアウトが短すぎて成功率低下。
  - 回避：デフォルトはやや長め＋早期確定で体感短縮。

### Plan 2: テスト画像セットと簡易ベンチ（成功率/処理時間の可視化）
- 目的：「改善した/悪化した」を数値で判断できるようにし、回帰を防ぐ。
- 作業内容（チェックリスト）：
  - [ ] `test/ocr-samples/`（または`assets/ocr-samples/`）に代表画像を10〜20枚用意
  - [ ] 各画像に正解ラベル（JSON）を付与（systolic/diastolic/pulse）
  - [ ] ブラウザ上で一括実行できる簡易ベンチ画面 or デバッグコマンドを用意
  - [ ] 指標を出力
    - [ ] 成功率（SYS/DIAが正しい率、3値すべて正しい率）
    - [ ] 平均処理時間、P95処理時間
    - [ ] 失敗の分類内訳（抽出失敗/範囲外/タイムアウト等）
- 変更対象（想定ファイル/モジュール）：
  - `js/ocr.js`
  - （追加）`test/ocr-samples/*`、`test/ocr-labels.json`（命名は任意）
  - （必要なら）`index.html`にデバッグ専用リンク/画面
- 受け入れ基準（完了条件）：
  - ベンチを回すと、成功率と処理時間が出力される。
  - 変更前後で比較できる（ログをコピー/保存可能）。
- テスト/検証：
  - 1回の実行で結果が安定して出ること（同一端末で大きくブレない）。
- 依存関係・注意点：
  - 画像は個人情報に当たらないよう、血圧計表示のみ/背景を極力避ける。
- リスクと回避策：
  - リスク：サンプルが偏って過学習。
  - 回避：照明/角度/機種差を意識して追加し続けられる構造に。

### Plan 3: フォールバック導線の最終整理（再試行/手動入力/ヒント）
- 目的：OCRが難しい条件でもユーザー体験を壊さずに完了できるようにする。
- 作業内容（チェックリスト）：
  - [ ] “低確信”時の振る舞いを統一（自動入力＋要確認、または入力抑止＋要確認）
  - [ ] 再試行時に「別パターン優先」や「解像度を上げる」など戦略を変える
  - [ ] ユーザー向け撮影ヒント（明るさ、反射、枠内合わせ）を表示できるように（短文）
- 変更対象（想定ファイル/モジュール）：
  - `js/ocr.js`
  - （連携）`js/app.js`, `index.html`, `css/style.css`（表示文言/ボタンが必要な場合）
- 受け入れ基準（完了条件）：
  - OCR失敗〜再試行〜手動入力までが詰まらず進める。
  - “誤って自動記録”が起きにくい（要確認が機能）。
- テスト/検証：
  - ぼやけた画像で失敗→再試行→手動入力まで流せることを確認。
- 依存関係・注意点：
  - Step 3-4のUI要件（信頼度色分け、再試行ボタン）と整合させる。 fileciteturn0file0
- リスクと回避策：
  - リスク：再試行が多くなりストレス。
  - 回避：再試行は1回まで等の制限＋撮り直し誘導。

