## 前提・要約
- 目的：Chart.js（4.x）で「過去7日分」の血圧推移（最高/最低/脈拍）を折れ線グラフとして表示し、メンバーで絞り込めるようにする。
- 成果物：
  - グラフ表示UI（canvas + コンテナ + フィルターUI）
  - 日付集計（同日複数記録は平均）＋7日抽出＋昇順ソートのデータ処理
  - Chart.js描画ロジック（更新/再描画含む）
  - 主要ユースケースの手動テスト手順
- 対象の種類（推定）：改修（既存の入力・保存・一覧表示に「可視化」を追加するため）
- 成功条件（Done）：
  - 過去7日分のデータが、最高血圧（赤）/最低血圧（青）/脈拍（緑・右Y軸）で正しく表示される
  - 同日複数記録がある場合、日別平均で表示される
  - メンバーフィルター（全員/個別）が動作し、選択に応じてグラフが更新される
  - データが7日未満/0件でも破綻せず、適切な表示（空表示メッセージ等）になる
  - スマホでも崩れず操作できる（横幅/タップ領域/文字サイズ）
- 前提（仮定した点があれば明記）：
  - Step 1-3（ローカル保存）とStep 1-7（Sheets連携）が完了し、アプリ内で「記録データ配列」を参照できる状態
  - 記録データの基本形は { id, member, systolic, diastolic, pulse, datetime(ISO) }
  - グラフのX軸はカテゴリ（MM/DD文字列）で実装し、timeアダプタ等の追加ライブラリは使わない（依存を増やさない）
- 主要な制約：
  - PWA（Android/モバイル中心）での表示最適化
  - Chart.jsはCDN読み込み、バージョンは4.x
  - 既存のUI/保存ロジックと衝突しない（特にメンバー選択UI）
- 既知の不明点（あれば）：
  - グラフのデータソースを「ローカルのみ」「SheetsのGET結果も含める」のどちらを最終採用するか（本Planでは“ローカル優先＋あれば同期”で進める）

## 全体ステップ構成
- Step1: 仕様の確定とデータソース方針（集計範囲/日付扱い/同期方針）
- Step2: UI追加（グラフ領域・フィルター・空表示）
- Step3: データ処理（7日抽出・日別平均・ソート）
- Step4: Chart.js導入と基本描画（3系列・右Y軸）
- Step5: 更新・フィルター連動（再描画/破棄/イベント）
- Step6: レスポンシブ/UX仕上げとテスト

---

## Step1: 仕様の確定とデータソース方針
### Plan 1: データソースと更新タイミングの整理（スパイク）
- 目的：グラフ描画に使う“正”のデータ配列と更新タイミングを確定し、後工程の手戻りを防ぐ。
- 作業内容（チェックリスト）：
  - [ ] app.js内で参照できる「記録一覧配列」（例: records）を特定する
  - [ ] 画面ロード時：ローカル読み込み →（可能なら）Sheets取得 → マージ/同期、の流れを採用するか決める
  - [ ] グラフ更新トリガーを列挙（新規保存、削除、フィルター変更、ページ初期表示）
  - [ ] 日付の扱いを決める（ローカルタイムでの日付切り替え、datetime-local由来のISOの解釈）
  - [ ] 「過去7日」の定義（今日含む7日、0:00区切り）を決める
- 変更対象（想定ファイル/モジュール）：
  - js/app.js（既存のデータ取得/保持の把握、方針メモ）
- 受け入れ基準（完了条件）：
  - データソース（ローカル優先/同期方針）と更新トリガーがメモとして残っている
  - 7日範囲・日付計算ルールが明文化されている
- テスト/検証：
  - 既存データで console/log などで配列形状とdatetime形式を確認（開発者ツール）
- 依存関係・注意点：
  - Step 1-3/1-4/1-7 の実装形に依存
- リスクと回避策：
  - リスク：SheetsのGETが遅延/失敗しグラフが不安定
  - 回避策：ローカル即描画→同期後に再描画（オンライン時のみ）に寄せる

### Plan 2: グラフ表示の最小仕様（MVP）を確定
- 目的：Chart.js実装のスコープを固定し、2〜3時間枠で終わる粒度に落とす。
- 作業内容（チェックリスト）：
  - [ ] まずは「折れ線のみ」「7日固定」「日別平均」までをMVPとする
  - [ ] ラベル表示（MM/DD）とツールチップ表示（値単位はmmHg/bpm）を決める
  - [ ] 脈拍の右Y軸は必須（左は血圧mmHg）
  - [ ] データ0件時の表示（メッセージ＋空グラフ非表示）を必須にする
- 変更対象（想定ファイル/モジュール）：
  - README.md（任意：仕様メモ）
- 受け入れ基準（完了条件）：
  - MVPの表示要件が箇条書きで確定している
- テスト/検証：
  - なし（仕様確定）
- 依存関係・注意点：
  - Phase 4で拡張する前提（期間選択など）はこのStepでは入れない
- リスクと回避策：
  - リスク：要望追加で工数超過
  - 回避策：MVPを明確化し、拡張はPhase 4に送る

---

## Step2: UI追加（グラフ領域・フィルター・空表示）
### Plan 1: index.htmlにグラフ表示エリアを追加
- 目的：Chart.jsの描画先（canvas）と、表示領域の構造を用意する。
- 作業内容（チェックリスト）：
  - [ ] 「グラフ」セクションを追加（見出し＋説明）
  - [ ] canvas要素を追加（id例: bpChart）
  - [ ] グラフ用コンテナを作り、レスポンシブに伸縮できる構造にする
  - [ ] データ0件時のメッセージ表示領域（例: emptyChartMessage）を用意
- 変更対象（想定ファイル/モジュール）：
  - index.html
- 受け入れ基準（完了条件）：
  - ブラウザ表示で「グラフ」領域が崩れず表示される
  - canvasがDOM上に存在し、サイズが意図通り確保される
- テスト/検証：
  - DevToolsでcanvas要素の存在とサイズ確認
- 依存関係・注意点：
  - 記録一覧領域と並び順（上/下）を決めておく（一般には一覧の上にグラフ）
- リスクと回避策：
  - リスク：canvasの高さが0で見えない
  - 回避策：コンテナ/高さ指定（CSS）を最初に入れる

### Plan 2: フィルターUIを追加（全メンバー/個別）
- 目的：グラフ表示対象をユーザーが切り替えられるようにする。
- 作業内容（チェックリスト）：
  - [ ] グラフ用のメンバーセレクトを追加（id例: chartMemberFilter）
  - [ ] 先頭に「全メンバー」オプションを追加
  - [ ] 既存の入力フォーム用メンバーselectと“役割が衝突しない”ように分離（別id）
  - [ ] ラベル/タップ領域/フォントサイズをモバイル前提に調整
- 変更対象（想定ファイル/モジュール）：
  - index.html
  - css/style.css
- 受け入れ基準（完了条件）：
  - セレクト操作がしやすく、誤操作しにくい
  - 入力フォームのメンバー選択と独立して動作する
- テスト/検証：
  - 実機/モバイル幅で操作テスト
- 依存関係・注意点：
  - メンバー一覧のソース（固定配列/DOMから参照）を統一する方針があるとよい
- リスクと回避策：
  - リスク：メンバー追加時に2箇所修正が必要
  - 回避策：JSで同一のメンバー定義から両方のselectを生成する（可能なら）

---

## Step3: データ処理（7日抽出・日別平均・ソート）
### Plan 1: 7日分抽出ロジックを実装
- 目的：グラフ用に「過去7日（今日含む）」のレコードに絞る。
- 作業内容（チェックリスト）：
  - [ ] 記録配列から日時をDateに変換し、7日範囲に入るものだけ抽出
  - [ ] 範囲計算の基準（今日の0:00〜）をStep1の仕様に沿って実装
  - [ ] メンバーフィルター（全員/個別）をここで適用できるようにする
- 変更対象（想定ファイル/モジュール）：
  - js/app.js（データ整形関数の追加/既存関数の拡張）
- 受け入れ基準（完了条件）：
  - 今日を含む直近7日だけが返る（境界日が正しい）
- テスト/検証：
  - テスト用に日時の異なるダミーデータ（7日外/内）で結果を確認
- 依存関係・注意点：
  - datetimeがISO文字列で保存されている前提。形式が混在する場合は正規化が必要
- リスクと回避策：
  - リスク：タイムゾーン差で日付がズレる
  - 回避策：ローカルタイムで日付キーを作る（YYYY-MM-DD）

### Plan 2: 日付グループ化＋平均化ロジックを実装
- 目的：同日に複数記録がある場合に日別平均で1点にまとめる。
- 作業内容（チェックリスト）：
  - [ ] 日付キー（YYYY-MM-DD）でグループ化
  - [ ] systolic/diastolic/pulse を平均（四捨五入 or 小数1桁などルール決定）
  - [ ] ラベル用にMM/DDに変換
- 変更対象（想定ファイル/モジュール）：
  - js/app.js
- 受け入れ基準（完了条件）：
  - 同日の複数レコードが1点に集約され、値が平均になる
- テスト/検証：
  - 同日2件（例: 120/80/70 と 140/90/80）で平均が期待通りか確認
- 依存関係・注意点：
  - 平均処理は“整数で扱う”ほうがUI上見やすい（mmHg/bpm）
- リスクと回避策：
  - リスク：平均の丸めで見え方が変わる
  - 回避策：丸めルールを仕様として固定し、ツールチップに元データ件数を出すのは将来拡張に回す

### Plan 3: グラフ用データ構造への変換（昇順ソート）
- 目的：Chart.jsに渡せる labels と datasets を安定生成する。
- 作業内容（チェックリスト）：
  - [ ] 日付の昇順にソート（古い→新しい）
  - [ ] labels: ["MM/DD", ...]
  - [ ] data配列: systolic[], diastolic[], pulse[] を同一順序で作る
  - [ ] 欠損日（測定なし）をどう扱うか決める（MVPでは欠損日を埋めず“点がない日”として扱う）
- 変更対象（想定ファイル/モジュール）：
  - js/app.js
- 受け入れ基準（完了条件）：
  - labels/datasetsの長さが一致し、昇順になっている
- テスト/検証：
  - consoleで生成データを確認（ソート順・配列長）
- 依存関係・注意点：
  - 欠損日を埋めると表示が分かりやすいが工数が増える（本Stepではやらない）
- リスクと回避策：
  - リスク：日付文字列ソートが誤る
  - 回避策：Dateオブジェクト/タイムスタンプでソートしてからラベル化

---

## Step4: Chart.js導入と基本描画（3系列・右Y軸）
### Plan 1: Chart.jsをCDNで導入
- 目的：Chart.js 4.x を読み込み、描画できる土台を作る。
- 作業内容（チェックリスト）：
  - [ ] index.htmlにChart.js CDNスクリプトを追加（Chart.js 4.x）
  - [ ] app.js（または専用モジュール）からChartが参照できることを確認
  - [ ] 読み込み順（Chart.js → 自作JS）を担保
- 変更対象（想定ファイル/モジュール）：
  - index.html
- 受け入れ基準（完了条件）：
  - DevToolsでChartグローバルが利用可能（またはimport相当）
- テスト/検証：
  - 簡易にnew Chart()が例外なく呼べること（コンソールで確認）
- 依存関係・注意点：
  - バージョン固定（4.x）で導入し、将来の破壊的変更を避ける
- リスクと回避策：
  - リスク：CDNがブロック/オフライン時に読み込めない
  - 回避策：Phase 4のオフライン強化で静的キャッシュ対象に入れる（ここでは準備だけ）

### Plan 2: 基本折れ線グラフを描画（最高/最低/脈拍）
- 目的：指定の3系列を色分けして表示し、脈拍を右Y軸に分離する。
- 作業内容（チェックリスト）：
  - [ ] 初期表示時にグラフを描画する関数（例: renderChart(chartData)）を用意
  - [ ] データセット
    - [ ] systolic（赤、左Y）
    - [ ] diastolic（青、左Y）
    - [ ] pulse（緑、右Y= y1）
  - [ ] オプション
    - [ ] responsive: true
    - [ ] legend/tooltips/grid を有効
    - [ ] 左Y（mmHg）と右Y（bpm）でラベルを分ける
  - [ ] 既存チャートがある場合は破棄して再生成できるようにする（後Stepで使用）
- 変更対象（想定ファイル/モジュール）：
  - js/app.js
  - css/style.css（canvasの表示調整が必要なら）
- 受け入れ基準（完了条件）：
  - 過去7日分の折れ線グラフが表示され、色・右軸が仕様通り
  - ツールチップ/凡例が表示される
- テスト/検証：
  - サンプルデータ（2〜7日分）で系列が正しく出るか確認
- 依存関係・注意点：
  - Chart.jsのtime scaleを使う場合はadapterが必要になるため避ける（カテゴリラベルで対応）
- リスクと回避策：
  - リスク：右Y軸のスケールが大きく離れて視認性が落ちる
  - 回避策：右軸はpulseのみ、左軸は血圧のみ、線の太さ/ポイントで判別しやすくする

---

## Step5: 更新・フィルター連動（再描画/破棄/イベント）
### Plan 1: フィルター変更でグラフ更新
- 目的：ユーザー操作で表示データが切り替わる体験を完成させる。
- 作業内容（チェックリスト）：
  - [ ] chartMemberFilter の change イベントで再計算→再描画
  - [ ] “全メンバー”の場合はフィルターしない
  - [ ] フィルター後データが0件なら空表示メッセージを出し、チャートを非表示（または空データ描画）
- 変更対象（想定ファイル/モジュール）：
  - js/app.js
- 受け入れ基準（完了条件）：
  - メンバー切替で即座にグラフが更新される
  - 0件時に分かりやすい案内が表示される
- テスト/検証：
  - メンバー別にデータを用意し、切替で系列が変わることを確認
- 依存関係・注意点：
  - 既存の入力フォームselectとはイベントを混同しない
- リスクと回避策：
  - リスク：再描画時にチャートが重なる/メモリリーク
  - 回避策：Chartインスタンスを保持し、更新前にdestroyする運用を徹底

### Plan 2: データ更新（追加/削除）時にグラフも更新
- 目的：記録操作とグラフの表示が常に同期する状態にする。
- 作業内容（チェックリスト）：
  - [ ] 「記録する」成功後に、一覧更新と同じタイミングでグラフ更新を呼ぶ
  - [ ] 「削除」成功後も同様にグラフ更新を呼ぶ
  - [ ] Sheets同期が非同期で後から来る場合：同期完了後にグラフ再描画（オンライン時のみ）
- 変更対象（想定ファイル/モジュール）：
  - js/app.js
- 受け入れ基準（完了条件）：
  - 追加/削除後にリロードせずグラフが更新される
- テスト/検証：
  - 追加→グラフに反映、削除→グラフから消える を確認
- 依存関係・注意点：
  - 既存の一覧更新関数があるならそこにフックする（重複実装を避ける）
- リスクと回避策：
  - リスク：同期完了のタイミング違いで“瞬間的に表示が戻る”
  - 回避策：同期のマージ方針をStep1で固定し、同一ID重複を防ぐ

### Plan 3: チャート描画関数の責務分離（可読性/保守性）
- 目的：Phase 4（グラフ強化）に備え、拡張しやすい構造にする。
- 作業内容（チェックリスト）：
  - [ ] getChartSourceRecords()（データ取得）
  - [ ] buildChartData(records, filter)（加工）
  - [ ] renderOrUpdateChart(chartData)（描画/更新）
  - [ ] updateChartUIState(hasData)（空表示など）
  のように関数を分ける
- 変更対象（想定ファイル/モジュール）：
  - js/app.js
- 受け入れ基準（完了条件）：
  - ロジックが分割され、どこで何をしているか追いやすい
- テスト/検証：
  - 既存機能（保存/一覧/削除）が壊れていないことを一通り確認
- 依存関係・注意点：
  - ファイル分割（chart.js等）をするかは任意。ただし工数内なら app.js に収めてもよい
- リスクと回避策：
  - リスク：リファクタで既存イベントが壊れる
  - 回避策：変更前に“動作確認チェックリスト”を用意し、Plan6で回帰する

---

## Step6: レスポンシブ/UX仕上げとテスト
### Plan 1: レスポンシブ調整（スマホでの見やすさ）
- 目的：モバイルで読める・触れるグラフ領域に仕上げる。
- 作業内容（チェックリスト）：
  - [ ] グラフコンテナに適切な高さ（例: 240〜320px）と余白を付与
  - [ ] 小さい画面で凡例が詰まる場合の対策（位置変更、フォントサイズ調整）
  - [ ] フィルターUIのタップ領域（最低44px）を担保
  - [ ] 横向き時の表示崩れ確認
- 変更対象（想定ファイル/モジュール）：
  - css/style.css
- 受け入れ基準（完了条件）：
  - スマホ幅でスクロール不要でグラフが視認できる（必要な場合でも破綻しない）
- テスト/検証：
  - Chrome DevToolsのデバイスエミュレーション + 実機で確認
- 依存関係・注意点：
  - 一覧テーブルが横スクロールの場合、グラフとの優先度（視線誘導）を意識
- リスクと回避策：
  - リスク：canvas比率が変で線が潰れる
  - 回避策：Chart.jsのmaintainAspectRatio設定の見直し（必要なら）

### Plan 2: 手動テストケース作成と回帰テスト
- 目的：グラフ機能追加による既存機能の破壊を防ぎ、Doneを満たす。
- 作業内容（チェックリスト）：
  - [ ] 初期表示：データ0件→空表示が出る
  - [ ] 1〜6日分：欠けても描画できる
  - [ ] 7日以上：直近7日だけ表示される
  - [ ] 同日複数：平均になっている
  - [ ] フィルター：全員/個別で更新される
  - [ ] 追加/削除：リロードなしで反映
  - [ ] 既存の保存/一覧/削除が正常動作
  - [ ] オフライン（ネットワーク断）でもローカルデータでグラフが表示される
- 変更対象（想定ファイル/モジュール）：
  - README.md（任意：テスト手順を残す）
- 受け入れ基準（完了条件）：
  - 上記チェックがすべて通る
- テスト/検証：
  - 実機（Android Chrome）で最低1回通し、問題があれば修正して再実施
- 依存関係・注意点：
  - Sheets同期の有無で結果が変わる場合は、テスト条件を分けて記録
- リスクと回避策：
  - リスク：本番（実機）だけで表示が崩れる
  - 回避策：最後に必ず実機で確認し、CSSを微調整するPlanを確保

