# Phase 2 Step 2-1: カメラアクセス機能 - テストガイド

## 実装概要

以下の機能を実装しました：

### 1. 実装ファイル

- **index.html**: カメラ撮影ボタンとモーダルUIを追加
- **css/style.css**: モーダルとカメラプレビュー用のスタイルを追加
- **js/camera.js**: カメラ制御モジュール（起動/停止/キャプチャ）を新規作成
- **js/app.js**: カメラUI配線とイベントハンドリングを追加

### 2. 主要機能

#### カメラ起動
- セキュアコンテキスト（HTTPS/localhost）チェック
- `getUserMedia` API対応チェック
- 背面カメラ優先（`facingMode: environment`）
- 制約エラー時の自動リトライ（汎用constraintsで再試行）

#### カメラ停止
- 全trackの停止（`track.stop()`）
- `srcObject`のクリア
- メモリリーク防止

#### 静止画キャプチャ
- video → canvas → Blob変換
- 最大解像度制限（1280px）
- JPEG形式（品質85%）
- CustomEventでの通知（`camera:captured`）

#### エラーハンドリング
- `NotAllowedError`: 権限拒否
- `NotFoundError`: カメラ未検出
- `NotReadableError`: カメラ占有中
- `OverconstrainedError`: 制約不一致
- `NotSupportedError`: API非対応
- セキュアコンテキスト外のアクセス

#### UI/UX
- モーダル表示/非表示
- ローディング表示
- エラー表示
- ボタン無効化/有効化
- Escキーで閉じる
- 背景クリックで閉じる
- ページ非表示時の自動停止（`visibilitychange`/`pagehide`）

---

## テスト手順

### 前提条件

**重要**: カメラAPIはセキュアコンテキスト（HTTPS または localhost）でのみ動作します。

### テスト環境のセットアップ

#### 方法1: ローカルサーバー（推奨）

```powershell
# プロジェクトディレクトリで実行
# Python 3の場合
python -m http.server 8000

# Node.jsのhttp-serverを使う場合
npx http-server -p 8000
```

ブラウザで `http://localhost:8000` にアクセス

#### 方法2: Visual Studio Code Live Server

1. VS Codeで `index.html` を開く
2. 右クリック → "Open with Live Server"
3. 自動的に `http://127.0.0.1:5500` などで開く

---

## テストケース

### ✅ 基本動作テスト

#### TC-1: カメラ起動・プレビュー表示
1. ブラウザで `http://localhost:8000` を開く
2. 「📷 カメラで撮影」ボタンをクリック
3. **期待結果**:
   - モーダルが開く
   - カメラ権限を求めるダイアログが表示される（初回のみ）
   - 権限を許可すると、プレビューが表示される
   - ローディング表示が消える
   - シャッターボタンが有効になる

#### TC-2: 静止画キャプチャ
1. TC-1でカメラ起動後
2. 「📸 シャッター」ボタンをクリック
3. **期待結果**:
   - ボタンが「📸 撮影中...」に変わる
   - コンソールに `[Camera] キャプチャ成功` が表示される
   - 成功メッセージが表示される
   - モーダルが閉じる
   - カメラが停止する

#### TC-3: カメラ停止
1. TC-1でカメラ起動後
2. 「✕ 閉じる」ボタンをクリック
3. **期待結果**:
   - モーダルが閉じる
   - カメラが停止する（他のアプリでカメラ使用可能）

#### TC-4: 連続起動
1. TC-3まで実行後
2. 再度「📷 カメラで撮影」ボタンをクリック
3. **期待結果**:
   - 正常にカメラが起動する
   - クラッシュしない

---

### ✅ エラーケーステスト

#### TC-5: 権限拒否
1. ブラウザのカメラ権限を拒否する（サイト設定から）
2. 「📷 カメラで撮影」ボタンをクリック
3. **期待結果**:
   - エラーメッセージが表示される
   - 「カメラの使用が許可されていません...」という案内が出る
   - シャッターボタンが無効のまま

#### TC-6: HTTP接続（セキュアコンテキスト外）
**注意**: このテストは実際のHTTP環境が必要です
1. HTTP（非HTTPS）でアクセス
2. 「📷 カメラで撮影」ボタンをクリック
3. **期待結果**:
   - 「カメラはHTTPSまたはlocalhostでのみ使用できます」というエラーが表示される

---

### ✅ UI/UXテスト

#### TC-7: Escキーで閉じる
1. カメラ起動後
2. キーボードの `Esc` キーを押す
3. **期待結果**:
   - モーダルが閉じる
   - カメラが停止する

#### TC-8: 背景クリックで閉じる
1. カメラ起動後
2. モーダルの背景（黒い部分）をクリック
3. **期待結果**:
   - モーダルが閉じる
   - カメラが停止する

#### TC-9: ページ切替時の自動停止
1. カメラ起動後
2. 別のタブに切り替える、またはアプリを最小化
3. **期待結果**:
   - カメラが自動停止する（掴みっぱなしにならない）

---

### ✅ モバイルテスト（Android Chrome推奨）

#### TC-10: Android実機テスト
1. Android端末で Chrome を開く
2. 同一ネットワーク上のPCのIPアドレスでアクセス（例: `http://192.168.1.100:8000`）
   - または GitHub Pages / Netlify などでHTTPSデプロイしてアクセス
3. 「📷 カメラで撮影」ボタンをタップ
4. **期待結果**:
   - 背面カメラが起動する（端末の向きによって前面になる場合あり）
   - プレビューが表示される
   - シャッターで撮影できる

#### TC-11: 画面回転
1. TC-10でカメラ起動後
2. 端末を縦↔横に回転
3. **期待結果**:
   - UIが崩れない
   - 閉じるボタンが押せる

---

## コンソールログの確認

ブラウザのDevTools（F12）のコンソールで以下のログが確認できます：

```
[Camera] カメラ機能を初期化しました
[Camera] カメラモーダルを開く
[Camera] startCamera() called
[Camera] Requesting camera with facingMode: environment
[Camera] Camera stream obtained
[Camera] Video playback started
[Camera] カメラ起動成功
[Camera] 静止画をキャプチャ
[Camera] capturePhoto() called
[Camera] Capturing: 1920x1080
[Camera] Captured: 123456 bytes, 1280x720
[Camera] キャプチャ成功 {blob: Blob, objectUrl: "blob:...", width: 1280, height: 720}
[Camera] カメラモーダルを閉じる
[Camera] stopCamera() called
[Camera] Track stopped: video
[Camera] Camera stopped
```

---

## 既知の制約・制限事項

### 必須要件
- ✅ HTTPS または localhost 環境
- ✅ ユーザー操作（ボタンクリック）からの起動
- ✅ カメラへのアクセス権限

### ブラウザ対応
- ✅ Chrome/Edge (推奨)
- ✅ Safari (iOS 11+)
- ⚠️ Firefox (一部制約あり)
- ❌ Internet Explorer (非対応)

### 端末差異
- 一部端末では背面カメラ指定（`facingMode: environment`）が効かない場合があります
  - → 汎用constraintsで自動リトライされます
- 端末によっては `videoWidth/videoHeight` が 0 の瞬間があります
  - → `loadedmetadata`/`canplay` イベントで待機しています

---

## Step 2-2以降の拡張予定

現在のStep 2-1では「カメラ起動→撮影→画像取得」までを実装しています。

### Step 2-2で追加予定の機能
- 撮影画像のプレビュー表示
- 再撮影/採用ボタン
- 画像のリサイズ・圧縮
- EXIF向き補正

### Step 2-3で追加予定の機能
- オーバーレイガイド枠
- 撮影ヒント表示

### Step 2-4で追加予定の機能
- 撮影画像からフォームへの連携

---

## トラブルシューティング

### カメラが起動しない

#### 原因1: セキュアコンテキスト外
- **症状**: 「HTTPSまたはlocalhostでのみ使用できます」エラー
- **対処**: localhost または HTTPS環境でアクセス

#### 原因2: 権限拒否
- **症状**: 「カメラの使用が許可されていません」エラー
- **対処**: ブラウザのサイト設定でカメラ権限を許可

#### 原因3: 他のアプリがカメラ占有中
- **症状**: 「カメラが使用できません」エラー
- **対処**: 他のカメラアプリ（Zoom、Skype等）を終了

#### 原因4: ブラウザ非対応
- **症状**: 「お使いのブラウザはカメラ機能に対応していません」エラー
- **対処**: Chrome、Safari、Edgeの最新版を使用

### シャッターボタンが無効

- カメラ起動後、プレビューが表示されるまで数秒かかる場合があります
- `loadedmetadata`/`canplay` イベントを待っています
- プレビューが表示されない場合は、カメラ起動が失敗している可能性があります（コンソールログ確認）

---

## 完了基準（DoD）

- [x] HTTPS（またはlocalhost）で「カメラで撮影」→プレビュー表示→「シャッター」で画像Blobを取得できる
- [x] 「閉じる」でストリームが停止し、カメラが解放される
- [x] 権限拒否/非対応/HTTPアクセス時にユーザーへ分かるエラー表示が出る
- [x] 連続起動（start→stop→start）が安定して動く
- [x] ページ非表示時（バックグラウンド）にカメラが自動停止する
- [ ] Android実機での動作確認（ユーザーによるテストが必要）

---

以上でPhase 2 Step 2-1の実装が完了しました。
