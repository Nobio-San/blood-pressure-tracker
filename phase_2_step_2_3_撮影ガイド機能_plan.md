## 前提・要約
- 目的：血圧計を「ブレにくく・狙った表示領域に収めて」撮影できるよう、カメラプレビュー上に撮影ガイド（枠・テキスト・任意のグリッド・ヒント）を表示する。
- 成果物：
  - カメラプレビュー（モーダル）上に表示されるガイドオーバーレイ（枠＋マスク＋テキスト＋任意グリッド）
  - ガイドの表示/非表示・端末回転/画面サイズ変更時の追従
  - （将来のOCR/ROI切り抜き用）ガイド枠のROI情報を取得できる関数/データ
- 対象の種類（推定）：改修（Phase 2 Step 2-1/2-2で作ったカメラプレビューに、ガイドUIを追加）
- 成功条件（Done）：
  - カメラプレビュー起動時にガイド枠＋案内テキストが重なって表示され、シャッター/閉じる操作を阻害しない
  - ガイド枠は画面サイズに応じて適切にリサイズされ、回転（縦/横）でも破綻しない
  - 低〜中価格帯Android端末でも表示が重くならない（レイアウト崩れ・著しいフレーム落ちがない）
  - （任意）グリッド線のON/OFFが可能、もしくは設定フラグで出し分け可能
- 前提（仮定した点があれば明記）：
  - Step 2-1（カメラプレビューのモーダル表示）と Step 2-2（撮影→プレビュー→再撮影/使用）が実装済みで、プレビューDOMにフックできること
  - カメラプレビューは `video` 要素で表示され、コンテナ要素（例：`.camera-preview`）が存在すること
  - 今Stepでは「表示ガイド」中心で、露出/フォーカス等のカメラ制御は行わない
- 主要な制約：
  - PWA（Android/Chrome想定）での動作が最優先
  - 追加ライブラリなし（素のHTML/CSS/JS）
  - カメラストリームは `object-fit: cover` 等でトリミングされ得るため、ガイド位置は“表示上”の座標として扱う
- 既知の不明点（あれば）：
  - 既存 `camera.js` のDOM構造（モーダルのクラス名、シャッターボタン配置、プレビューコンテナ）の詳細

## 全体ステップ構成
- Step1: 仕様整理とUI設計（ガイド枠サイズ/配置、テキスト、グリッド、操作阻害の回避）
- Step2: オーバーレイ基盤実装（DOM生成/重ね合わせ/クリック透過/セーフエリア）
- Step3: ガイド枠のレイアウトとリサイズ追従（縦横比・回転・画面サイズ）
- Step4: 付加要素（テキスト/ヒント/任意グリッド）と将来拡張（ROI取得）
- Step5: 動作確認・仕上げ（端末差・アクセシビリティ・パフォーマンス）

---

## Step1: 仕様整理とUI設計
### Plan 1: ガイドUI仕様の確定（スパイク）
- 目的：作り込み前に「枠の大きさ・位置・文言・グリッド有無」を決め、後戻りを防ぐ。
- 作業内容（チェックリスト）：
  - [ ] ガイド枠の推奨比率を決める（例：表示領域に合わせて横長/縦長のどちらを優先するか）
  - [ ] 枠の配置方針を決める（中央固定／上寄せ 等）
  - [ ] マスク（周囲を暗くする）の濃さ・枠線の太さ・角丸有無を決める
  - [ ] 案内テキスト文言を決める（短く/読みやすく）
  - [ ] シャッターボタン領域と干渉しない位置取り（下部UIを避ける）を決める
  - [ ] （任意）3x3グリッドの表示方針（常時/設定/デバッグのみ）を決める
- 変更対象（想定ファイル/モジュール）：
  - `js/camera.js`（プレビューDOMの把握）
  - `css/style.css`（既存のカメラUIスタイル確認）
- 受け入れ基準（完了条件）：
  - ガイド枠のサイズ/位置/見た目/文言/グリッド有無が文章で整理され、実装方針が定まっている
- テスト/検証：
  - 既存モーダルで「枠を置きたい領域」と「ボタン領域」のスクショ/メモを残す
- 依存関係・注意点：
  - Step 2-1のプレビュー画面構造が前提
- リスクと回避策：
  - リスク：端末によってプレビューUIの安全領域（ノッチ等）が異なり、下部操作と干渉
  - 回避策：下部UIに固定余白（safe-area）を確保する設計にする

---

## Step2: オーバーレイ基盤実装
### Plan 1: ガイドオーバーレイのDOM追加（クリック透過）
- 目的：カメラプレビューに重なるオーバーレイ層を追加し、操作ボタンを阻害しない構造を作る。
- 作業内容（チェックリスト）：
  - [ ] プレビューコンテナ内に「ガイド用ラッパー要素」を追加（`camera.js`で動的生成を推奨）
  - [ ] オーバーレイを `position: absolute; inset: 0;` で重ねる
  - [ ] オーバーレイは原則 `pointer-events: none` にして操作を邪魔しない
  - [ ] 将来的にON/OFFするため、クラス/属性で表示制御できるようにする
  - [ ] モーダルを閉じるときにDOM/イベントが残らないようクリーンアップ
- 変更対象（想定ファイル/モジュール）：
  - `js/camera.js`
  - `css/style.css`
- 受け入れ基準（完了条件）：
  - プレビュー表示中にオーバーレイが常に最前面に描画される
  - シャッター/閉じる等のUI操作がオーバーレイ追加後も正常に動作する
- テスト/検証：
  - 実機（Android/Chrome）で、連打含めシャッター・閉じる・再オープンを行い操作不能が起きない
- 依存関係・注意点：
  - z-indexの競合（モーダル内のボタンが見えなくならない順序）に注意
- リスクと回避策：
  - リスク：z-index調整でボタンが隠れる
  - 回避策：レイヤー構造を「video < overlay < controls」に統一し、CSS変数/定数で管理

### Plan 2: マスク（周囲を暗くする）実装方針の確定と実装
- 目的：枠外を暗くして視線誘導し、枠内を目立たせる。
- 作業内容（チェックリスト）：
  - [ ] 実装方式を選ぶ
    - 方式A：CSSで枠要素に `box-shadow` を巨大に付けてマスク化（実装が簡単）
    - 方式B：4枚のマスク要素（上/下/左/右）で枠周囲を覆う（細かな制御が可能）
  - [ ] 方式Aを基本推奨（軽量で簡単）。必要なら方式Bへ切替できる設計
  - [ ] マスク濃度（例：rgba(0,0,0,0.45)）を調整
  - [ ] 枠の角丸に合わせて自然に見えるよう調整
- 変更対象（想定ファイル/モジュール）：
  - `css/style.css`
  - `js/camera.js`（枠要素の生成）
- 受け入れ基準（完了条件）：
  - 枠外が半透明に暗くなり、枠内が視認しやすい
  - パフォーマンス劣化（カクつき）が目立たない
- テスト/検証：
  - 明るい場所/暗い場所でプレビューを開き、枠内外の見やすさを確認
- 依存関係・注意点：
  - `object-fit: cover` で映像がトリミングされていても、ガイドは“画面上”の誘導でOK
- リスクと回避策：
  - リスク：マスクが濃すぎて表示が見えない
  - 回避策：CSS変数で濃度を調整可能にしておく

---

## Step3: ガイド枠のレイアウトとリサイズ追従
### Plan 1: ガイド枠のサイズ/位置ロジック実装
- 目的：端末サイズに応じた適切なガイド枠を表示し、UI（下部操作）と干渉しない。
- 作業内容（チェックリスト）：
  - [ ] プレビューコンテナの実寸（幅/高さ）を取得し、枠サイズを計算
  - [ ] 枠の最大サイズを制限（例：幅はコンテナの85〜90%以内、高さはコンテナの45〜60%以内 等）
  - [ ] 下部の操作UIを避けるため、枠のY位置に下限/上限を設ける（下部余白を確保）
  - [ ] 角丸・枠線太さ・色を適用
  - [ ] 計算結果をスタイル（CSS変数やstyle属性）に反映
- 変更対象（想定ファイル/モジュール）：
  - `js/camera.js`
  - `css/style.css`
- 受け入れ基準（完了条件）：
  - 小型端末でも枠がはみ出さず、操作ボタンと重ならない
  - 大型端末でも枠が小さすぎず、表示領域を合わせやすい
- テスト/検証：
  - DevToolsのデバイスモードで複数解像度を切替
  - 実機で縦/横を切替して枠の追従を確認
- 依存関係・注意点：
  - モーダル内の「操作UI領域」の高さが固定でない場合は、実測して避ける（要DOM参照）
- リスクと回避策：
  - リスク：端末ごとのUI高さ差で枠がボタンに被る
  - 回避策：ボタンコンテナの`getBoundingClientRect()`で安全領域を計算して避ける

### Plan 2: 画面回転/リサイズ時の再計算（デバウンス）
- 目的：縦横回転やアドレスバー表示変化でレイアウトが崩れないようにする。
- 作業内容（チェックリスト）：
  - [ ] `resize` / `orientationchange` を監視し、枠レイアウト再計算を実行
  - [ ] 連続発火に備えてデバウンス（例：100〜200ms）
  - [ ] モーダルクローズ時にイベントリスナーを確実に解除
- 変更対象（想定ファイル/モジュール）：
  - `js/camera.js`
- 受け入れ基準（完了条件）：
  - 回転しても枠・テキストが表示領域内に収まり続ける
  - モーダルを開閉してもイベントが二重登録されない
- テスト/検証：
  - 端末回転を数回繰り返し、枠がズレない/重くならないことを確認
- 依存関係・注意点：
  - 一部端末で `orientationchange` が遅延する可能性があるため `resize` も併用
- リスクと回避策：
  - リスク：再計算中に一瞬ガタつく
  - 回避策：CSSトランジションを控えめに、必要ならrequestAnimationFrameで反映

---

## Step4: 付加要素と将来拡張（ROI）
### Plan 1: ガイドテキスト表示（読みやすさ・配置）
- 目的：ユーザーに「何を枠に合わせるべきか」を明確に伝える。
- 作業内容（チェックリスト）：
  - [ ] テキスト要素をオーバーレイに追加（例：枠の上 or 下）
  - [ ] 文言：例「血圧計の表示部分を枠内に合わせてください」
  - [ ] 背景に薄いプレート（半透明）を敷き、映像上でも読めるようにする
  - [ ] フォントサイズ/行間/コントラストを調整
- 変更対象（想定ファイル/モジュール）：
  - `js/camera.js`
  - `css/style.css`
- 受け入れ基準（完了条件）：
  - 明るい/暗い環境でもテキストが読める
  - テキストが操作UIや枠と重ならない
- テスト/検証：
  - 実機で屋内/屋外想定の明暗差を試し、視認性を確認
- 依存関係・注意点：
  - 文字数が長いと改行が増えるため、2行以内を目安に
- リスクと回避策：
  - リスク：背景プレートが大きくて邪魔
  - 回避策：コンパクトなスタイル（最大幅/余白/角丸）で調整

### Plan 2: 撮影ヒント（任意：簡易チップ）
- 目的：ブレ・反射・暗さによる失敗を減らす（後続OCR精度にも寄与）。
- 作業内容（チェックリスト）：
  - [ ] ヒントを短文で2〜3個用意（例：距離、明るさ、反射注意）
  - [ ] 常時表示ではなく、テキスト下に小さく/一定時間だけ表示など、邪魔しない出し方にする
  - [ ] モーダル表示直後に数秒だけ表示→自動でフェードアウト（任意）
- 変更対象（想定ファイル/モジュール）：
  - `js/camera.js`
  - `css/style.css`
- 受け入れ基準（完了条件）：
  - ヒントが邪魔にならず、撮影時に視線誘導として機能する
- テスト/検証：
  - ヒント表示中でもシャッターが押しやすいことを確認
- 依存関係・注意点：
  - 文言は短く、視認性優先
- リスクと回避策：
  - リスク：情報過多で逆に邪魔
  - 回避策：デフォルトは最小限、必要なら設定で拡張

### Plan 3: グリッド線（3x3）オプション実装
- 目的：水平/中心合わせの補助を提供（好みによりON/OFF）。
- 作業内容（チェックリスト）：
  - [ ] グリッド線要素をオーバーレイに追加（軽量なCSSで線を描画）
  - [ ] デフォルト表示方針に従い、ON/OFF切替を用意（フラグ or ボタン）
  - [ ] 枠内にのみ表示するか、全面に表示するかを決めて実装
- 変更対象（想定ファイル/モジュール）：
  - `css/style.css`
  - `js/camera.js`
- 受け入れ基準（完了条件）：
  - 表示しても見づらくならず、パフォーマンス影響が小さい
- テスト/検証：
  - ON/OFF切替の反映、回転時の追従を確認
- 依存関係・注意点：
  - 線が濃すぎると数字が見えにくいので薄めに
- リスクと回避策：
  - リスク：低スペック端末で描画が重い
  - 回避策：DOM要素数を増やさず、背景のlinear-gradient等で描画

### Plan 4: （将来のPhase 3向け）ガイド枠ROIの取得APIを用意
- 目的：後続の画像切り抜き（ROI）に使えるよう、枠座標を“正規化”して取り出せるようにする。
- 作業内容（チェックリスト）：
  - [ ] ガイド枠の表示上座標（コンテナ基準）を取得
  - [ ] `x,y,w,h` を 0〜1 の正規化値（コンテナ幅/高さで割る）で保持
  - [ ] `camera.js` 内に `getGuideROI()` のような関数を用意（撮影処理が参照可能）
  - [ ] 将来、キャプチャ用canvasへの変換（表示→元画像座標）を行う際の注意点をコメントに残す（`object-fit`トリミングの影響）
- 変更対象（想定ファイル/モジュール）：
  - `js/camera.js`
- 受け入れ基準（完了条件）：
  - ガイド枠の正規化ROIが取得でき、ログ等で値が確認できる
- テスト/検証：
  - 画面サイズ/回転ごとにROIが妥当（0〜1の範囲、枠サイズに応じた値）であることを確認
- 依存関係・注意点：
  - Phase 3で“実画像座標”に変換する際は、videoの表示倍率/トリミングを考慮する必要がある
- リスクと回避策：
  - リスク：ROIをそのまま切り抜くとズレる
  - 回避策：本Stepでは「正規化ROIの提供」までに留め、変換ロジックはPhase 3で検証する

---

## Step5: 動作確認・仕上げ
### Plan 1: 端末差テスト（操作性・視認性・回転）
- 目的：実機での“使える”品質を確保する。
- 作業内容（チェックリスト）：
  - [ ] Android/Chromeでガイド表示を確認（可能なら複数端末）
  - [ ] 縦/横回転で枠・テキストが崩れないことを確認
  - [ ] シャッター/閉じる/再撮影など主要操作が阻害されないことを確認
  - [ ] 暗所/反射あり環境で、マスク濃度・枠線が適切か確認
- 変更対象（想定ファイル/モジュール）：
  - 必要に応じて `css/style.css`, `js/camera.js`
- 受け入れ基準（完了条件）：
  - 主要操作が詰まらず、ガイドとして役立つ見た目になっている
- テスト/検証：
  - チェックリストの結果をメモし、調整点を反映
- 依存関係・注意点：
  - カメラ許可ダイアログ後の表示状態も確認
- リスクと回避策：
  - リスク：機種依存の表示崩れ
  - 回避策：絶対値ではなく相対レイアウト（%/vw/vh）を優先

### Plan 2: アクセシビリティ/可読性の最低限対応
- 目的：家族利用（高齢者含む）を想定し、最低限の読みやすさを担保する。
- 作業内容（チェックリスト）：
  - [ ] テキストのコントラスト確保（半透明背景＋白文字など）
  - [ ] フォントサイズを大きめに（最小16px、推奨18px）
  - [ ] 可能なら `aria-label` 等を既存ボタンに付与（ガイド追加で壊れていないか確認）
- 変更対象（想定ファイル/モジュール）：
  - `css/style.css`
  - `js/camera.js`（必要なら属性付与）
- 受け入れ基準（完了条件）：
  - テキストが読め、操作を妨げない
- テスト/検証：
  - 画面輝度を下げても読めるかを確認
- 依存関係・注意点：
  - ガイド自体は操作対象ではないため、基本はpointer-events無しでOK
- リスクと回避策：
  - リスク：背景が動画で変化し読みにくい
  - 回避策：テキスト背面プレート/影で強制的に可読性を上げる

### Plan 3: パフォーマンス・メモリの簡易チェック
- 目的：モーダル開閉を繰り返しても重くならない状態を保つ。
- 作業内容（チェックリスト）：
  - [ ] モーダルを複数回開閉し、イベントが二重登録されないことを確認
  - [ ] 余計なDOMが増殖しないことを確認
  - [ ] 低スペック端末で体感フレーム落ちが悪化していないことを確認
- 変更対象（想定ファイル/モジュール）：
  - `js/camera.js`
- 受け入れ基準（完了条件）：
  - 開閉を繰り返しても挙動が安定し、重さが増えない
- テスト/検証：
  - DevToolsのPerformance/Memory（可能範囲）でざっくり確認
- 依存関係・注意点：
  - マスク方式によっては描画コストが上がるため、方式A（box-shadow）優先
- リスクと回避策：
  - リスク：オーバーレイ再生成がコスト高
  - 回避策：必要なら再利用（表示/非表示切替）＋クリーンアップ徹底

