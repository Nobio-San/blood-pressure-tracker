```md
# ProjectRules.md（Cursor Project Rules 貼り付け用）

## 1. 目的とスコープ
- 目的:
  - 血圧計の表示部を「ブレにくく・狙った表示領域に収めて」撮影できるよう、カメラプレビュー（モーダル）上に撮影ガイド（枠・マスク・案内テキスト・任意グリッド・ヒント）を重ねて表示する。
- スコープ（やること）:
  - プレビュー上のガイドオーバーレイ（枠＋マスク＋案内テキスト＋任意グリッド）
  - ガイドの表示/非表示
  - 画面サイズ変更/端末回転（縦横）でのレイアウト追従
  - （将来のOCR/ROI切り抜き用）ガイド枠ROI（正規化座標）を取得できるAPI
- 非スコープ（やらないこと）:
  - OCR実装、画像のROI切り抜き実装（本StepではROI提供まで）
  - 露出/フォーカス等のカメラ制御
  - 外部ライブラリの追加

## 2. 技術スタック
- 使用言語: HTML / CSS / JavaScript（素の実装）
- 実行環境: PWA（Android/Chrome最優先）
- 依存/前提:
  - Phase 2 Step 2-1/2-2でカメラプレビュー（モーダル）が実装済み
  - プレビューは `video` 要素で表示され、プレビューコンテナ（例: `.camera-preview`）にフックできる
  - `object-fit: cover` 等により映像がトリミングされ得る（ガイドは“表示上”の座標で扱う）

## 3. ディレクトリ/ファイル方針
- 変更対象（最小）:
  - `js/camera.js` : ガイドDOM生成・レイアウト計算・表示制御・ROI API・イベント管理
  - `css/style.css` : ガイドの見た目（枠/マスク/テキスト/グリッド）・レイヤー（z-index）
  - `index.html`（または既存HTML）: 可能なら既存ボタンへ `aria-label` など属性追加（必要時のみ）
- 構成方針:
  - 追加機能は **camera.js内で「設定（定数）／DOM生成／レイアウト計算／イベント管理」を分離** して書く
  - 魔法数は `const GUIDE_CONFIG = { ... }` に集約（割合・濃度・余白・デバウンス時間など）

## 4. コーディング規約（横断）
- 命名:
  - JS: lowerCamelCase（例: `updateGuideLayout`）
  - CSS: BEM（例: `.camera-guide__frame`）に統一
- コメント:
  - 原則日本語。関数の「入力/出力/副作用（DOM更新・イベント登録）」を先頭1行で明記
- 分離:
  - 設定/定数、レイアウト計算（純粋関数寄り）、DOM更新、イベント登録解除を分ける
- 禁止:
  - setInterval の乱用（リサイズ追従は debounce / rAF で）
  - グローバル変数で状態を散らす（モーダル単位で閉じ込める）

## 5. 実装ルール（プロジェクト固有）
### 5.1 レイヤー構造（z-index）
- 原則: `video < overlay(guide) < controls(シャッター/閉じる)`
- z-indexはCSS変数で管理（例: `--z-video: 0; --z-guide: 10; --z-controls: 20;`）

### 5.2 オーバーレイDOM（クリック透過）
- ガイドはプレビューコンテナ直下に生成して重ねる
- オーバーレイ全体は `pointer-events: none`（操作ボタンを絶対に阻害しない）
- 表示/非表示はクラスで制御（例: `.camera-guide.is-hidden { display:none; }`）
- モーダルクローズ時は **DOMとイベントを必ずクリーンアップ**（二重登録・DOM増殖を防ぐ）

### 5.3 マスク（枠外を暗くする）
- 基本方式（推奨）: 枠要素に巨大 `box-shadow` でマスク
  - 例: `box-shadow: 0 0 0 9999px rgba(0,0,0,0.45);`
- マスク濃度・枠線・角丸はCSS変数にして調整可能にする
- 代替方式（必要時）: 上下左右4枚マスク方式へ切替可能な設計（ただしデフォルトは方式A）

### 5.4 ガイド枠のレイアウト計算
- 計算は「プレビューコンテナの実寸（`getBoundingClientRect()`）」を基準にする
- **下部の操作UI（シャッターなど）と干渉しない**よう、操作UIコンテナの `getBoundingClientRect()` を参照して安全領域を確保する
- 目安（設定で調整可能に）:
  - 枠幅: コンテナ幅の 0.85〜0.90
  - 枠高: コンテナ高の 0.45〜0.60
  - 下部余白: `max(操作UI高さ + 余白, env(safe-area-inset-bottom) + 余白)`
- 画面に合わせる比率（要件未確定）:
  - TODO: 血圧計の「表示部」縦横比を確定し、`GUIDE_CONFIG.frameAspect` に固定値を入れる
  - それまでは `frameAspect` を設定値として扱い、幅優先→高さ制限で調整する

### 5.5 リサイズ/回転追従（デバウンス）
- `resize` と `orientationchange` を監視し、ガイドレイアウトを再計算
- 連続発火対策としてデバウンス（例: 150ms、設定化）
- モーダル閉鎖時にリスナー解除（同じ関数参照でremoveできる形にする）

### 5.6 任意グリッド（3x3）
- ON/OFFは設定フラグまたはクラス切替で実現
- DOM要素を増やしすぎない（推奨: 1要素に `linear-gradient` 背景で線を描く）
- 線は薄め（数字の視認を邪魔しない）

### 5.7 案内テキスト/ヒント
- 案内テキスト（必須）:
  - 例文: 「血圧計の表示部分を枠内に合わせてください」
  - 映像上でも読めるよう半透明プレート＋高コントラスト文字
  - 2行以内を目安
- 撮影ヒント（任意）:
  - 情報過多にしない（短文2〜3個、必要なら数秒でフェードアウト）

### 5.8 ROI取得API（将来拡張）
- `getGuideROI()` を `camera.js` 内で提供
  - 返り値: `{ x, y, w, h }`（0〜1の正規化、コンテナ基準）
- コメントで注意点を残す:
  - `object-fit: cover` のトリミングがあるため、**表示座標 → 実画像座標** への変換はPhase 3で別途検証が必要

## 6. UI/UX・入力操作の規約
- ガイドは操作対象ではない（基本 `aria-hidden="true"`、かつ `pointer-events: none`）
- シャッター/閉じる/再撮影など既存UIを最優先し、ガイドが被らない配置にする
- アクセシビリティ最低限:
  - テキストは最小16px（推奨18px）
  - 可能な範囲で既存ボタンに `aria-label` 付与（ガイド追加で壊していないか確認）

## 7. パフォーマンス/品質
- 低〜中価格帯Androidでも重くならないことを優先
- レイアウト更新は「イベント発火ごとに毎回DOM再生成」しない
  - 生成は1回、更新はCSS変数/スタイル更新に寄せる
- 再計算の抑制:
  - `getBoundingClientRect()` 呼び出しは必要最小限（同フレーム内で使い回す）
  - デバウンス + 必要なら `requestAnimationFrame` で反映をまとめる
- マスクは方式A（box-shadow）をデフォルト（軽量・要素数最小）

## 8. テスト/デバッグ（DoD）
- 表示:
  - カメラプレビュー起動時に **枠＋案内テキスト** が表示され、映像と自然に重なる
  - ガイドは最前面だが **シャッター/閉じる操作を阻害しない**（タップ可能、連打でも問題なし）
- レスポンシブ:
  - 画面サイズ変更・縦横回転で枠/テキストがはみ出さず、ボタン領域とも干渉しない
  - 回転を複数回繰り返してもズレない/重くならない（イベント二重登録なし）
- 任意機能:
  - （実装した場合）グリッドON/OFFが即時反映される
- ROI:
  - `getGuideROI()` が `{x,y,w,h}` を返し、全値が 0〜1 の範囲に収まる
  - 端末回転/リサイズ後もROIが破綻しない
- 安定性/メモリ:
  - モーダル開閉を繰り返してもDOM増殖・イベント増殖が起きない
- 視認性:
  - 明るい/暗い環境で枠外マスク・テキストが読める（濃度は調整可能）

## 9. リリース/更新運用
- 仕様（plan/todo）更新時は、以下を必ず反映:
  - 枠の比率/サイズ割合、文言、グリッド方針、回転時の挙動、ROI APIの仕様
- 変更点の残し方:
  - PR/コミットに「変更理由」「確認観点（端末/回転/操作）」を日本語で残す

## 10. 禁止事項/アンチパターン
- 指定なしでの外部ライブラリ追加（FW/ユーティリティ含む）
- オーバーレイで操作を塞ぐ実装（`pointer-events: auto` のまま全面に被せる等）
- setIntervalで常時再計算（リサイズ追従のためのループ化）
- DOMを開閉のたびに増殖させる、イベントを解除しない
- マスク/グリッドで要素数を過剰に増やす（低スペ端末で悪化）

## 11. コミット/PR運用（任意）
- 1コミット=1意図（例: 「ガイドDOM追加」「レイアウト計算追加」「回転追従とクリーンアップ」）
- PRにはスクリーンショット/動画（縦/横）と、DoDチェック結果を添付

---

### 付録A: 実装メモ（推奨の最小API）
- `createGuideOverlay(containerEl)` : ガイドDOM生成（1回）
- `updateGuideLayout({ containerRect, controlsRect })` : 枠/テキスト位置の再計算（副作用はstyle更新のみ）
- `toggleGuideVisible(isVisible)` : 表示/非表示
- `toggleGuideGrid(isOn)` : グリッドON/OFF（任意）
- `getGuideROI()` : 正規化ROI返却（{x,y,w,h}）
- `disposeGuide()` : イベント解除 + DOM破棄
```

```md
# 生成ログ（要約）
- 抽出要件: プレビュー（モーダル）上に「枠＋マスク＋案内テキスト＋任意グリッド＋ヒント」を重ね、操作ボタンを阻害しないこと。
- 抽出要件: 端末回転/リサイズに追従（resize/orientationchange + デバウンス）、モーダル閉鎖時にDOM/イベントをクリーンアップ。
- 抽出要件: PWA（Android/Chrome）最優先、外部ライブラリなし、低〜中価格帯でも重くならない実装（要素数最小、box-shadowマスク推奨）。
- 抽出要件: 将来のOCR/ROI切り抜きのため、ガイド枠ROIを0〜1正規化で取得するAPIを提供。
- 未確定点: 血圧計表示部の推奨縦横比（`frameAspect`）はTODOとして設定化し、後で確定値に置換。
- 仮定: プレビューは `video` + プレビューコンテナ（例 `.camera-preview`）があり、操作UIコンテナの矩形が取得できる。
```

