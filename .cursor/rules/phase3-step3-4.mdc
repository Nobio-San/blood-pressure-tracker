```md
# Project Rules（OCR結果の自動入力と確認UI）

## 1. 目的とスコープ
- 目的
  - 血圧計の撮影後にOCRを自動実行し、「最高血圧（systolic）/最低血圧（diastolic）/脈拍（pulse）」を入力フォームへ自動入力する。
  - ユーザーが結果をすぐ確認・修正できるUI（信頼度表示、色分け、再試行、失敗フォールバック）を提供し、記録ミスと手間を減らす。
- スコープ（やること）
  - 撮影画像の「使用」確定後にOCRを自動開始
  - OCR実行中UI（ローディング/進捗）
  - OCR成功時：3項目の自動入力＋信頼度表示＋色分け
  - 確認UI：『修正する』『そのまま記録』、必要に応じて『再試行』
  - 手動編集で「自動入力表示」を解除（編集した値が最終保存値）
  - OCR失敗時：画像保持のまま手動入力/再試行/撮り直し導線
- 非スコープ（勝手に増やさない）
  - サーバー送信によるOCR（クライアント内で完結）
  - UIフレームワーク（React/Vue等）の追加
  - 新規データ項目追加（最高/最低/脈拍以外）
  - 高度な機械学習最適化（ROI自動推定等）は別フェーズ

## 2. 技術スタック
- 使用言語
  - HTML / CSS / JavaScript（ES Modules）
- 主要ライブラリ/前提
  - クライアントOCR：Tesseract.js（Web Worker利用を前提）
  - PWA/モバイル（Android Chrome）を主要対象
- 依存/前提（既存がある想定）
  - `js/ocr.js` に「画像→抽出結果」を返す関数がある（例：`recognizeText(image, { onProgress })`）
  - 撮影フロー（例：`js/camera.js`）から「確定した画像（Base64/Blob/canvas）」を `js/app.js` へ渡せる
  - 既存フォームの状態管理・保存は `js/app.js` 側に集約されている

## 3. ディレクトリ/ファイル方針
- 変更対象（最低限）
  - `index.html`：OCRバナー/ボタン/信頼度バッジのDOM枠
  - `css/style.css`：状態別の見た目（バナー/バッジ/自動入力装飾）
  - `js/app.js`：状態管理、OCR起動、フォーム反映、UIレンダリング
  - `js/ocr.js`：OCR実行API（進捗callback対応の余地）、例外の整形
  - `js/camera.js`：画像確定イベント（必要なら）
  - `README.md`：テスト手順/仕様メモ
  - （任意）`docs/ocr-ui.md`：状態遷移図、UI文言、閾値
- 読み込み順
  - HTML → CSS → JS（`type="module"`）
- 状態/UI更新は **`app.js` へ集約**
  - DOM更新関数は `renderOcrUI(state)` のように1箇所へ集め、分岐を散らさない

## 4. コーディング規約（横断 + 言語別）
- 共通
  - 命名：意図が伝わる語彙、略語の乱用禁止
  - コメント：原則日本語。関数の入出力・副作用を先頭1行で明記
  - 構造：設定/定数・ドメインロジック・I/O・UI更新を層分離
  - 依存：グローバル共有を最小化。状態は `app.js` の単一ソースに寄せる
- HTML
  - セマンティックタグ、`aria-*`、`aria-live`（ステータスバナー）を付与
  - タップ領域：ボタンは **最小44px**（高さ/幅のいずれも）
- CSS
  - BEM（`block__elem--mod`）またはUtilityのどちらかに統一（混在禁止）
  - 色だけに依存しない（✓/!/✕やラベルを併用）
- JavaScript
  - ES Modules、入力処理/状態更新/描画（DOM更新）を分離
  - OCRは非同期。例外を握りつぶさず `failed` へ遷移
  - 魔法数禁止：閾値や上書きポリシーは定数として1箇所に集約（例：`const OCR_CONFIDENCE = { high: 90, mid: 70 }`）

## 5. 実装ルール（プロジェクト固有）
### 5.1 状態設計（State）
- OCR状態：`idle` / `running` / `success` / `failed`
- 画像状態：`noImage` / `hasImage`（プレビュー保持）
- `app.js` の状態（例）
  - `ocrStatus: 'idle' | 'running' | 'success' | 'failed'`
  - `ocrResult: { systolic?: number, diastolic?: number, pulse?: number, confidence?: number, fieldConf?: { systolic?: number, diastolic?: number, pulse?: number }, rawText?: string } | null`
  - `ocrError: { message: string, code?: string } | null`
  - `ocrProgress: number | null`（0-1。取れない場合は `null`）
  - `imageToken: string`（画像破棄・撮り直し時に古い結果を無視するためのトークン）

### 5.2 OCR開始トリガー
- 撮影画像の「使用」確定（プレビュー画面で確定）をトリガーにOCRを自動開始
- 連打対策
  - `running` 中はOCR再実行・保存・再撮影などの動作を **無効/抑止**（UI上も非活性表示）
  - 画像破棄/撮り直しが発生したら `imageToken` を更新し、完了しても結果を捨てる（キャンセル相当）

### 5.3 OCR結果の抽出と自動入力
- OCR成功時
  - `systolic/diastolic/pulse` の各inputへ値をセット
  - 自動入力メタ情報を付与：`data-autofilled="true"`（入力ごと）
  - 信頼度を付与：`data-confidence="92"` のように保持（取れない場合は省略）
- バリデーション
  - 既存バリデーションを再実行し、範囲外/不整合は **警告表示**（初期は「保存ブロック」まで強制しない。
    ただし安全に倒したい場合は `DoD` の基準に従いブロック可）

### 5.4 信頼度表示と色分け
- しきい値（既定）
  - 高：`> 90`（緑/✓）
  - 中：`70–90`（黄/!）
  - 低：`< 70`（赤/✕）
- 表示
  - 各フィールド横に `%` バッジ（例：`92%`）
  - 項目別が取れない場合：全体信頼度を3項目に共通表示、または「—」＋全体のみ表示（どちらかを `docs/ocr-ui.md` で固定）

### 5.5 確認UI（成功時）
- 成功時バナー文言（例）：「認識結果を確認してください」
- ボタン
  - 主：『そのまま記録』＝保存処理へ（既存の記録ボタンを呼び出しても良いが処理は一箇所に集約）
  - 副：『修正する』＝最初の入力欄へフォーカス + キーボード表示誘導
- `running` 中は『そのまま記録』を無効化（押しても無視/警告）

### 5.6 手動編集時の「自動入力表示解除」
- `input` / `change` イベントで該当フィールドの `data-autofilled` を解除
- 解除したフィールド
  - 背景色/枠線を通常へ戻す
  - 信頼度バッジは薄くする/非表示/`—`（仕様で統一）
- 保存時は **編集値を最優先**（OCR値に戻さない）

### 5.7 再試行（Retry）
- 表示条件
  - `failed` 時は必ず表示
  - `success` でも低信頼度（<70）が1つでもあれば表示（推奨）
- 上書きポリシー（既定：手戻り防止）
  - **未編集（data-autofilled=trueのまま）の項目のみ上書き**
  - 既に編集済みの項目は保持（必要なら「上書き確認」ダイアログを追加）
- 多重実行防止
  - `running` 中はretryボタン無効
  - 連続再試行は **最大3回**（既定）。超えたら「撮り直し」を促す

### 5.8 失敗フォールバック
- 失敗時バナー文言（例）：「自動読み取りに失敗しました。手動で入力するか再試行してください」
- 画像は保持したまま
  - フォームは常に手動入力可能
  - 可能なら失敗理由（短く）を表示：`タイムアウト/解析失敗` など
- タイムアウト（既定値は暫定）
  - TODO: 端末性能を見て `OCR_TIMEOUT_MS` を決める（例：20,000〜40,000ms）

## 6. UI/UX・入力操作の規約
- バナーの配置：画像プレビューの直下、フォームの直上（迷子防止）
- ローディング表示
  - 文言例：「読み取り中…」
  - 進捗が取れる場合：%表示（取れない場合はスピナーのみ）
- 視認性
  - フォントサイズ：本文 **16px以上**
  - 画面幅が狭い場合：バッジは折り返し許容（崩れないCSS）
- アクセシビリティ
  - バナーは `role="status"` + `aria-live="polite"`
  - ボタンは `aria-label` を適切に付与

## 7. パフォーマンス/品質
- OCRは重い前提
  - UIが固まって見えない問題を避けるため、開始時に必ずローディングDOMを先に描画（`requestAnimationFrame`/`setTimeout(0)`で描画を挟む等）
  - ワーカー（Tesseract worker）のライフサイクル方針を決める
    - 既定：ワーカー再利用（初期化コスト削減）
    - ただしメモリ増大が見えたら解放/再生成に切り替え
- ログ/計測
  - OCR開始/終了のmsを計測し、開発フラグでのみconsole出力（本番は静かに）
- 二重実行・競合
  - `imageToken` により「古い結果の上書き」を防止

## 8. テスト/デバッグ（DoD: Doneの定義）
- 受け入れ（必須シナリオ）
  - 成功：撮影→使用確定→OCR自動開始→完了後に3項目が自動入力→『そのまま記録』で保存
  - 修正：自動入力→1項目編集→その項目のみ自動入力装飾が解除→保存値は編集値
  - 失敗：OCR失敗→画像保持→手動入力で保存可能、または再試行で成功し反映
  - 低信頼度：黄色/赤が表示され、ユーザーが要確認と分かる（色+アイコン/ラベル）
  - 多重操作：OCR中の連打（再試行/保存/戻る）で多重実行やフリーズが起きない
  - レスポンシブ：小画面でもバナー/バッジ/ボタンが崩れない
- 実機確認
  - Android Chrome を最低1台で確認（OCR中に操作不能・フリーズしない）
- デバッグ手順（READMEに追記）
  - ダミー結果注入（開発フラグ）で `success/failed/low` を再現可能にする

## 9. リリース/更新運用
- `todo.md` / 仕様md 更新時
  - 変更点（状態、文言、閾値、ファイル構成、上書きポリシー）を本ルールへ差分反映
  - `docs/ocr-ui.md` に状態遷移図と文言を最新化
- 変更の粒度
  - UI（見た目）とロジック（状態遷移/入力反映）を別コミットに分ける

## 10. 禁止事項/アンチパターン
- 指定なしでの外部FW導入（React/Vue等）
- `setInterval` 乱用でUIスレッドを詰まらせる実装
- DOM更新や状態分岐を各所に散らす（`renderOcrUI` に集約）
- 魔法数の散在（閾値/回数/タイムアウト等は定数化）
- 失敗を握りつぶして沈黙（必ず `failed` に遷移し、手動入力導線を出す）
- 画像やOCR生テキストを常時ログ出力（個人情報/プライバシー配慮：開発時のみ）

## 11. コミット/PR運用（任意）
- 1コミット=1意図（例："OCR状態管理追加" / "成功時バナーUI"）
- メッセージは日本語で「要点→効果→影響範囲」
- PR（またはレビュー）観点
  - 状態遷移が破綻していないか
  - OCR中の多重操作対策が効いているか
  - 低信頼度/失敗フォールバックが詰まらないか

---

## 付録A: 既定値（プロジェクト内定数の例）
- `OCR_CONFIDENCE_HIGH = 90`
- `OCR_CONFIDENCE_MID  = 70`
- `OCR_RETRY_LIMIT = 3`
- `MIN_TAP_SIZE_PX = 44`
- `OCR_TIMEOUT_MS = TODO: ???`
```

```md
# 生成ログ（要約）
- OCR状態（idle/running/success/failed）と画像保持を前提に、撮影→確定→自動OCR→フォーム自動入力の導線をルール化。
- 自動入力は `data-autofilled` で管理し、編集で解除・保存は編集値優先。
- 信頼度は閾値（>90/70–90/<70）で色分けし、色＋アイコン/ラベルで誤認防止。
- 失敗時は画像保持のまま手動入力/再試行可能、再試行は未編集項目のみ上書きを既定に。
- パフォーマンス対策としてUI描画を先に行い、OCR計測ログは開発時のみ。
- 未確定：OCR進捗取得粒度、項目別信頼度が取れない場合の表示方針、OCRタイムアウト秒数（TODOで明示）。
```

