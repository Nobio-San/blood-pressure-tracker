```md
## 1. 目的とスコープ（本プロジェクトで何を作るか／作らないか）
- 目的:
  - 「カメラで撮影 → プレビュー → 『この画像を使う』」で確定した画像を、手動入力フォーム上で参照できる状態にし、画像を見ながら血圧値を入力→記録できる導線を完成させる。
- スコープ（やること）:
  - 入力フォーム上部に「撮影画像プレビュー」表示（サムネイル・状態ラベル・プレースホルダ）。
  - 画像タップで拡大モーダル表示（開閉、スクロール固定）。
  - 画像削除（破棄）・再撮影時の置き換え・保存成功後のリセット方針を実装。
  - camera.js → app.js の画像受け渡し（CustomEvent またはコールバック）を実装。
  - 画像がある状態でも、既存の手動入力→保存（ローカル/Sheets）フローを壊さない。
- 非スコープ（やらないこと）:
  - OCR（Phase 3 以降）。
  - Google Sheets へ画像自体を保存。
  - 画像の永続保存は「オプション扱い」。デフォルトは入力補助としての“一時保持”のみ。
  - 指定のない外部フレームワーク導入（React/Vue 等）。

## 2. 技術スタック
- 使用言語/技術:
  - HTML / CSS / JavaScript（PWA/モバイル前提）
  - （オプション）IndexedDB（画像を永続保存する場合のみ）
- 依存/前提:
  - Step 2-1〜2-3（カメラ起動、撮影、プレビュー、ガイド枠）は実装済みで、撮影結果の画像データ（Blob または Base64 DataURL）を取得できる。
  - 既存の手動入力（Phase 1）の保存ロジックおよびフォーム描画は `js/app.js` が担う。

## 3. ディレクトリ/ファイル方針
- 変更対象（基本）:
  - `index.html`
  - `css/style.css`
  - `js/app.js`
  - `js/camera.js`
- 追加ファイル（必要な場合のみ・最小限）:
  - `js/constants.js`（画像プレビューサイズ上限、モーダル設定などの定数を集約）
  - `js/imageUtils.js`（縮小・変換などの純粋関数を切り出す場合）
- 読み込み順:
  - HTML → CSS → JS（ES Modules を使う場合は `<script type="module">` に統一）
- 状態管理:
  - 「現在選択中の画像」は app.js 側で in-memory を基本（`currentSelectedImage = { dataUrl, blob?, createdAt }` 等）。
  - 永続保存が必要になるまで localStorage に DataURL を入れない（容量爆発防止）。

## 4. コーディング規約（言語横断 + 言語別の要点）
- 共通:
  - 命名: 意図が伝わる語彙、略語乱用禁止。JS は lowerCamelCase、CSS は BEM（`block__elem--mod`）または Utility のどちらかに統一。
  - 構造: 設定/定数・ドメインロジック・I/O・UI更新を層分離（UI更新がロジックを侵食しない）。
  - コメント: 原則日本語。関数の「入出力・副作用」を先頭1行で明記。
  - 依存: グローバル共有を最小化。イベント購読/解除を明確に。
  - 魔法数禁止: サイズ上限、品質、UI高さ上限などは定数へ。
- HTML:
  - セマンティックタグ、landmark、`aria-*` を付与。モーダルは `aria-modal="true"` と `role="dialog"`。
- CSS:
  - 画像は `object-fit` を前提に崩れを吸収（サムネイルは cover/contain を仕様で固定）。
  - アニメは `transform/opacity` を優先し、重い reflow を誘発しやすいプロパティを避ける。
- JavaScript:
  - ES Modules を優先。入力処理/状態/描画（DOM更新）を分離。
  - 画像処理（縮小/変換）は純粋関数化してテスト可能に。

## 5. 実装ルール（要件を実装ガイドに落とす）
### 5-1. camera.js ↔ app.js 連携I/F
- 受け渡し方式はどちらかに統一（混在しない）:
  - A案: CustomEvent（例: `document.dispatchEvent(new CustomEvent('image:selected', { detail: { previewDataUrl, originalBlob? } }))`）
  - B案: コールバック登録（例: `camera.onImageSelected((payload) => ...)`）
- 画像データ形式:
  - UIプレビュー用: 縮小済み DataURL を必須（長辺 720〜960px 推奨）。
  - 将来OCR用: 元Blob保持は“設計余地”として許可（ただし本フェーズ必須ではない）。
- 状態遷移（最低限）:
  - 未選択 →（画像確定）→ 選択中
  - 選択中 →（削除）→ 未選択
  - 選択中 →（再撮影で新規確定）→ 選択中（置き換え）

### 5-2. 入力画面の画像プレビューUI
- `index.html` の入力フォーム直上にプレビュー領域を追加。
- 未選択時:
  - 非表示またはプレースホルダ表示（例:「撮影するとここに画像が表示されます」）。
- 選択時:
  - サムネイル常時表示 + 状態ラベル（例:「撮影画像を参照中」）。
  - 削除ボタン（×/ゴミ箱）を画像枠に重ねて配置。
- フォームUX:
  - 入力欄プレースホルダ/ヒントに「画像を見ながら入力」等を追加（文言は既存UIに合わせる）。

### 5-3. 拡大モーダル
- サムネイルタップでモーダルを開く。
- 閉じ方:
  - 背景タップ、閉じるボタンのどちらか（推奨: 両方）。
- モーダル表示中:
  - 背面スクロールを固定（iOS/Android 両対応を想定）。
  - 画像は画面内に収める（contain）。
- 多重起動防止:
  - `isModalOpen` 等のフラグでガードし、二重モーダルを禁止。
  - camera.js 側のプレビューモーダルと同時に出ない導線にする（「この画像を使う」確定後に入力画面側のモーダルのみ使用）。

### 5-4. 画像削除・保存後リセット
- 削除:
  - `currentSelectedImage = null` に戻し、UIはプレースホルダ/非表示へ戻す。
- 再撮影:
  - 新規画像が来たら古い画像を置き換える（古い参照を必ず破棄）。
- 記録成功時の挙動:
  - デフォルト: フォームクリア時に画像もクリア。
  - TODO: 画像も記録に紐付けて保持する場合は Step4（IndexedDB 等）で扱う。

### 5-5. メモリ/リソースの破棄
- カメラストリーム:
  - 画面離脱・再撮影・停止時に `track.stop()` を確実に実行。
- 画像参照:
  - ObjectURL を使う場合は破棄時に `URL.revokeObjectURL()`。
  - DataURL/Blob は不要になったら参照を `null` に戻し、GC される状態にする。

## 6. UI/UX・入力操作の規約
- タップ操作:
  - サムネイル: 拡大モーダルを開く。
  - 削除ボタン: 確認なしで即削除（誤操作が問題なら「取り消しトースト」を追加。ただし要件にない場合は最小実装）。
- 表示領域:
  - サムネイル高さ上限: 160〜220px の範囲で固定（どれか1値を定数化）。
  - 画像の縦横比差は CSS（`object-fit`）で吸収。
- アクセシビリティ:
  - ボタンは `aria-label` を必須。
  - モーダルはフォーカスが迷子にならない最低限（開いたら閉じるボタンにフォーカス、閉じたらサムネイルへ戻す）。

## 7. パフォーマンス/品質
- 画像サイズ最適化:
  - プレビュー用 DataURL は長辺 720〜960px 目標（端末で重い場合はさらに縮小）。
  - （永続保存する場合）縮小JPEG 品質 0.7〜0.8 を目安、200KB〜500KB 以内を目標。
- DOM更新:
  - 画像の差し替えは `src` のみ更新し、不要な再生成/再レイアウトを抑える。
- 例外/フォールバック:
  - 画像処理失敗時は「画像なし」状態へ安全に戻し、数値入力・保存は継続可能にする。

## 8. テスト/デバッグ（DoD: 達成条件）
- 受け入れ（必須シナリオ）:
  - 撮影→プレビュー→「この画像を使う」後に、入力画面上部に画像が表示される。
  - 画像タップで拡大モーダルが開閉できる。
  - 画像削除で表示が消え、フォームが通常状態に戻る。
  - 画像がある状態でも、手動入力→保存（ローカル/Sheets）まで既存フローが壊れない。
- エッジケース:
  - 画像選択→削除→再撮影→保存→フォームクリアの一連操作が破綻しない。
  - 連続でモーダル開閉しても崩れない/重くならない。
  - 実機（Android Chrome）で基本導線が通る。
- 回帰:
  - 画像なしでも従来通り入力・保存・一覧・グラフが動く。
- デバッグ品質:
  - Console エラーなし。
  - Network オフ時でもローカル保存ができる（Phase 1 仕様維持）。

## 9. リリース/更新運用
- `todo.md` / 計画書（Phase 2 Step 2-4）更新時:
  - 変更点（イベント名、UI要素、画像サイズ、状態遷移）を本ルールへ差分反映。
- Issue/PR の最小テンプレ:
  - 目的 / 変更点 / 影響範囲 / 手順（撮影→使用→表示→保存）/ スクショ（可能なら）。

## 10. 禁止事項/アンチパターン
- 指定なしでの外部FW導入（React/Vue 等）
- 画像の Base64(DataURL) を localStorage に無制限保存（容量爆発）
- カメラストリームを停止せず残し続ける
- モーダル多重起動（閉じられない状態の発生）
- UI更新と保存ロジックを密結合して拡張不能にする
- 魔法数の散在（サイズ/品質/高さ上限など）

## 11. コミット/PR運用（任意）
- 1コミット=1意図（例:「画像受け渡しイベント追加」「入力画面にプレビュー枠」「モーダル/スクロール固定」）
- メッセージは日本語で「要点→効果→影響範囲」。

---

### 付録A: 画像保存（オプション）方針メモ
- デフォルト: 保存しない（入力補助として一時保持）。
- 保存する場合:
  - 保存先は IndexedDB 推奨（localStorage はすぐ上限になりやすい）。
  - 記録データは `imageId`（参照）を基本にし、容量不足時は画像を捨てて数値だけ保存できる設計にする。
```

```md
## 生成ログ
- 抽出した主要要件: 「カメラ画像を手動入力画面で参照」「サムネイル＋拡大モーダル」「削除/再撮影/保存後の状態リセット」「camera.js→app.js 受け渡し」「既存保存フローを壊さない」。
- 数値/条件の明文化: プレビュー画像は長辺 720〜960px、サムネイル高さ上限 160〜220px（定数化）、永続保存時は JPEG 品質 0.7〜0.8・200〜500KB目標。
- 主要なリスク対応: localStorage へのDataURL保存禁止、ストリーム停止/参照破棄（revoke/null）でメモリリーク回避、モーダル多重起動ガード。
- 未確定点（TODO）: 「画像も記録と一緒に保存」を最終的に有効化するか（必要なら IndexedDB を採用）。
- 自動補完した規約: 命名/層分離/魔法数禁止/アクセシビリティ（aria・フォーカス戻し）/回帰テスト観点。
```

