```md
# Project Rules

## 1. 目的とスコープ
- 目的：PWA（血圧記録アプリ）から Google Apps Script（Webアプリ）経由で Google スプレッドシートへ **記録の保存（POST）** と **記録の取得（GET）** を行い、**ローカルストレージと併用してオフライン耐性**を確保する。
- スコープ（やること）：
  - 記録の「ローカル保存」を必須（オフラインでも必ず保存できる）
  - オンライン時に Sheets へ追記（失敗してもアプリは継続）
  - （任意）Sheets からの取得（GET）は **デバッグ/同期基盤**として用意
  - （任意）未同期レコードの「再同期」導線（手動リトライ）
- 非スコープ（やらないこと）：
  - ブラウザから直接 Google Sheets API 認証（OAuth 等）を実装しない（Apps Script Webアプリ経由に固定）
  - 大量アクセス/高頻度同期を前提にした最適化（クォータ超過対策の高度化、ページング等）は本フェーズ外
  - “秘密情報を完全に秘匿”する設計（クライアントに置いたトークンは秘匿にならない）

## 2. 技術スタック
- フロント：HTML / CSS / JavaScript（PWA）
- 外部連携：Google Apps Script（Webアプリ）→ Google スプレッドシート
- 通信：fetch（JSON）、AbortController によるタイムアウト（推奨）
- 永続化：localStorage（将来拡張で IndexedDB も検討可だが本フェーズ外）

## 3. ディレクトリ/ファイル方針
- 主要ファイル（本フェーズの変更対象）：
  - `js/sheets-api.js`（新規：GAS Webアプリ呼び出しラッパ）
  - `js/app.js`（既存：保存フローへ組み込み、UX/エラー処理、未同期管理）
  - `index.html`（`sheets-api.js` 読み込み追加、必要なら再同期ボタン等）
  - （任意）`README.md`（`SCRIPT_URL` 設定手順、トラブルシュート、手動テスト）
- 読み込み順（非モジュール構成の場合の原則）：
  - `js/sheets-api.js` → `js/app.js`
- 設定/定数の置き場所：
  - `js/sheets-api.js` に「連携設定」を集約（`SCRIPT_URL`, `REQUEST_TIMEOUT_MS`, `API_TOKEN` 等）
  - `app.js` には UI 用メッセージ文言・同期間隔など “画面の都合” の定数のみ置く

## 4. コーディング規約（横断）
- 命名：意図が伝わる語彙を優先（略語を避ける）。JS は lowerCamelCase、CSS は BEM（または Utility のどちらかに統一）。
- コメント：原則日本語。関数の目的・入出力・副作用（localStorage更新/通信等）を先頭1行で明記。
- 構造：設定/定数、ドメインロジック、I/O（Storage/Network）、UI更新を層分離。
- 依存：グローバル共有を最小化。呼び出し方向は `app.js → sheets-api.js` の片方向。
- 魔法数禁止：タイムアウト、リトライ間隔などは定数化して意味のある名前を付ける。

### JavaScript（本プロジェクトの基本）
- 例外設計：通信層（`sheets-api.js`）は「失敗理由が分かる形」で返す（throw か `{ok:false, ...}` のどちらかに統一）。握りつぶさない。
- ログ：開発時の切り分け用に `console.error` は残してよいが、将来はフラグで抑制できる形にする。

## 5. 実装ルール（プロジェクト固有）

### 5.1 連携I/F（送受信フォーマット）
- フロント→GAS（POST）送信JSON（最低限）：
  - `id`（一意）
  - `datetime`（ISO8601 文字列推奨）
  - `member`
  - `systolic` / `diastolic` / `pulse`（数値）
- GAS→フロント（レスポンス）
  - 成功：`{ status: "success", message: "..." }` を期待
  - 失敗：`{ status: "error", message: "...", detail?: any }` など（HTTP 200 でも status を必ず判定）
- GET の戻りは “データ量が増えると重い” 前提。
  - 原則：デバッグ用途（同期表示の本実装はフェーズ外に留める）

### 5.2 `js/sheets-api.js` の責務
- **目的：GAS Webアプリとの通信を一本化**し、`app.js` は「保存戦略/UX」に集中できる状態にする。
- 必須API：
  - `saveToSheets(record)`：POST で1件追記
  - `getFromSheets()`：GET で一覧取得（任意/デバッグ）
- 実装必須ポイント：
  - `SCRIPT_URL` 未設定時は “すぐ分かる” エラーを返す（例：`throw new Error("SCRIPT_URL is not set")`）
  - タイムアウト：`AbortController` を使い `REQUEST_TIMEOUT_MS` を超えたら中断
  - エラー分類：
    - ネットワーク（オフライン/接続失敗）
    - HTTP（200以外）
    - アプリ層（JSONの `status !== success`）
    - JSON パース失敗
  - セキュリティ（任意）：トークンを付ける場合は **ヘッダー or クエリ**で送る（GAS側で検証）。

### 5.3 `js/app.js` の保存フロー（ローカル優先）
- 保存は必ず **2段階**：
  1) `saveToLocal(record)`：ローカル保存（最優先・必須）
  2) `trySyncToSheets(record)`：オンライン時のみ Sheets へ同期（失敗してもアプリは継続）
- ローカルのデータモデル（推奨）：
  - 既存レコードに以下を追加（互換性を壊さないよう読み込み時に補完）
    - `synced: boolean`（初期 false）
    - `syncedAt?: string`（成功時に設定）
- 画面通知（最低限）：
  - ローカル保存成功：ユーザーが “保存できた” と理解できる文言
  - 同期成功：任意（うるさければ省略してもよい）
  - 同期失敗：**「ローカル保存済み」** を必ず明記（不安を減らす）

### 5.4 未同期キューと再同期（任意だが推奨）
- 方針：`synced=false` を **未同期キュー**として扱う（別キュー構造を増やさない）。
- 再同期UI（任意）：
  - ボタン例：「未同期を再送」
  - 実行中は二重起動防止（disabled、スピナー、進捗表示のいずれか）
- 再送ルール：
  - 未同期のみを対象
  - 連続送信は数百ms程度の間隔を入れる（GAS負荷を抑える）
  - 途中失敗したら停止し、失敗理由を表示

### 5.5 重複対策（冪等性）
- 優先：クライアント側で `synced=true` は再送しない（まずこれを守る）。
- （可能なら）GAS側で `id` を検索し、既存なら append しない（成功扱いで返す）。

## 6. UI/UX・入力操作の規約
- 入力フォーム：
  - 必須項目（例：日時、最高/最低血圧、脈拍、メンバー）を明確化し、未入力は送信前にブロック
  - 数値は `Number()` で確実に数値化し、NaN を弾く
- 状態表示：
  - オフライン時は「オフライン（ローカル保存のみ）」が分かる表示を用意（小さくでよい）
  - 未同期件数（任意）：多く見せない（0/数件が分かる程度）
- メッセージは簡潔に：
  - 推奨文言例：「ローカルに保存しました（オンライン時に自動同期します）」

## 7. パフォーマンス/品質
- GET は重くなる前提：
  - `getFromSheets()` は “必要時のみ” 呼ぶ（画面初期化で毎回呼ばない）
- 再計算の抑制：
  - レンダリング用の配列生成を繰り返さない
  - localStorage の読み書きは必要最小限（1操作=1書き込みを基本）

## 8. テスト/デバッグ（DoD：完了条件）
- 正常系：オンラインで「記録する」→
  - ローカルに保存され、一覧に反映される
  - Sheets に1行追加される
- 異常系：オフライン（DevTools の Offline でも可）で「記録する」→
  - ローカル保存は成功し、ユーザー通知が出る
  - アプリが落ちない（未同期として保持）
- 復帰系：オンライン復帰後に（実装していれば）「未同期を再送」→
  - 未同期が 0 件になり、Sheets に反映される
- 取得（任意）：`getFromSheets()` の呼び出しで JSON が取得できる
- 開発者ツール：Console に致命的エラー（ReferenceError 等）がない／Network で URL・メソッド・payload が想定通り

## 9. リリース/更新運用
- `SCRIPT_URL` の差し替え箇所を 1か所に固定（`js/sheets-api.js`）。README にも同じ場所を明記。
- `todo.md / plan.md` 更新時は、次を Project Rules に差分反映：
  - 追加/変更されたファイル
  - 送受信I/F（JSONキー、レスポンス形式）
  - 例外/UXルール（失敗時の表示、再同期導線の有無）

## 10. 禁止事項/アンチパターン
- ローカル保存を後回しにしない（ネットワークに依存した保存フロー禁止）
- 失敗を握りつぶさない（成功に見せかける/無通知で終わるのは禁止）
- 目的なく `getFromSheets()` を常時実行しない（重くなる）
- `SCRIPT_URL` を複数箇所に分散して直書きしない
- “秘密トークン”を完全秘匿できる前提で設計しない（クライアント配布物にある時点で漏洩リスク）

## 11. コミット/PR運用（任意）
- 1コミット=1意図（例：通信層追加、保存フロー分離、未同期再送UI など）
- メッセージは日本語で「変更の要点 → 効果 → 影響範囲」

---

### 付録A：実装チェックリスト（最短）
- [ ] `index.html` に `js/sheets-api.js` を `app.js` より先に読み込む
- [ ] `sheets-api.js` に `SCRIPT_URL` / `REQUEST_TIMEOUT_MS` を集約
- [ ] POST は `JSON.stringify(record)`、`Content-Type: application/json`
- [ ] `app.js` は「ローカル保存→同期」の2段階
- [ ] 同期失敗でも「ローカル保存済み」を必ず通知
- [ ] 既存localStorageデータ読み込み時に `synced` を補完（互換性維持）
```

```md
# 生成ログ
- 抽出した主要要件：PWAからGAS Webアプリ経由でSheetsへPOST/GET、ローカル保存優先、オフライン耐性、エラー時もユーザーに通知。
- 反映した成果物：`js/sheets-api.js` 新規、`js/app.js` 保存フロー改修、`index.html` 読み込み順調整、（任意）`README.md`。
- 実装ルールの具体化：`synced`/`syncedAt` で未同期管理、AbortControllerでタイムアウト、HTTP200でも`status`判定、GETはデバッグ用途。
- 任意要件として整理：未同期再送ボタン、冪等性（重複対策）、簡易トークン。
- 未確定点は “設定集約” として吸収：`SCRIPT_URL` は `sheets-api.js` に1か所固定、READMEに明記。
```

