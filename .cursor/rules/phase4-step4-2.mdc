```md
# ProjectRules.md（血圧記録アプリ：グラフ機能強化 / Phase 4 Step 4-2）

## 1. 目的とスコープ
- 目的：血圧記録アプリのグラフ機能を「期間選択・グラフ種類切替・統計表示・目標ライン・時間帯/曜日分析」まで拡張し、日常的な振り返りと傾向把握をしやすくする。
- スコープ（作るもの）
  - 期間選択UI：7日 / 30日 / 90日 / 全期間（モバイルでワンタップ切替）
  - グラフ種類切替：折れ線（line）/ 棒（bar）/ 散布図（scatter）
  - 統計情報カード：平均・最小/最大・標準偏差・測定回数（選択条件に追随）
  - 目標ライン：収縮期/拡張期の目標値（入力・保存・ON/OFF・表示）
  - 分析ビュー：推移 / 時間帯別（朝/昼/夜） / 曜日別（月〜日）
  - Chart.js 表示品質改善：ツールチップ/凡例/グリッド/アニメーション調整
- 非スコープ（今回やらない）
  - 既存の記録/保存/一覧/フィルター/OCR連携の仕様変更
  - Chart.js の大型プラグイン追加（annotation 等は原則使わず標準機能で実現）
  - i18n（多言語化）や高度な統計（回帰分析等）
  - 通知/リマインド機能（別フェーズ）

## 2. 技術スタック
- フロント：HTML / CSS / JavaScript（ES Modules）
- グラフ：Chart.js（既存採用を前提）
- 保存：localStorage（期間・種別・ビュー・目標値などのUI状態）
- 前提（データ構造）
  - レコードは `{ id, member, systolic, diastolic, pulse, datetime(ISO) }` 相当で統一
  - フィルタ済みのレコード配列（例：`filteredRecords`）を起点に描画/統計/分析を行う

## 3. ディレクトリ/ファイル方針
- 変更対象（想定）
  - `index.html`：グラフ周辺UI（期間/種別/ビュー/目標）と表示領域
  - `css/style.css`：コントロール行・カード・レスポンシブ
  - `js/app.js`：フィルタ・集計・Chart.js描画・状態管理
- 推奨分割（既存構成を壊さず段階導入）
  - `js/graph/` を新設できる場合：
    - `js/graph/state.js`（UI状態とlocalStorage永続化）
    - `js/graph/filter.js`（期間×メンバーの共通フィルタ）
    - `js/graph/transform.js`（line/bar/scatter用データ整形）
    - `js/graph/stats.js`（統計算出）
    - `js/graph/views.js`（推移/時間帯/曜日の表示切替）
    - `js/graph/chart.js`（Chart.js options/datasets生成、destroy/update方針）
  - 分割できない場合：`js/app.js` 内で「// ===== graph: xxx =====」の塊に分け、関数単位で責務分離。
- 読み込み順：HTML → CSS → JS（ES Modulesの場合は `type="module"` を使用）
- 定数/設定：魔法数は `constants` オブジェクト（または `js/constants.js`）に集約
  - 例：期間日数（7/30/90）、時間帯境界（朝/昼/夜）、散布図点サイズ、間引き閾値

## 4. コーディング規約（横断）
- 命名
  - JS：lowerCamelCase、定数は UPPER_SNAKE_CASE も可（統一する）
  - CSS：BEM（`block__elem--mod`）またはUtilityのどちらかに統一
- 構造
  - 「設定/定数」→「ドメインロジック（フィルタ/集計/統計）」→「I/O（localStorage）」→「UI更新/描画」を層分離
  - グローバル共有は最小化し、関数の入出力（引数/戻り値）を明記
- コメント：原則日本語。関数の先頭に「何を受け取り、何を返すか」を1行で書く
- 例外処理
  - 日付パース失敗・欠損値は除外し、デバッグ用ログはフラグでON/OFFできるようにする

## 5. 実装ルール（プロジェクト固有）
### 5.1 状態管理（単一Stateオブジェクト）
- グラフ関連の状態は1つのオブジェクトに集約し、UI・描画・統計が同じStateを参照する
  - 例：
    - `memberId`（全員/個人）
    - `rangeKey`（"7d"/"30d"/"90d"/"all"）
    - `chartType`（"line"/"bar"/"scatter"）
    - `viewMode`（"trend"/"timeband"/"weekday"）
    - `targetEnabled`（boolean）
    - `targetSys` / `targetDia`（number | null）
- Stateの更新は `setGraphState(patch)` に寄せ、
  - (1) state更新 → (2) localStorage保存 → (3) `renderAll()`（グラフ/統計/補助テキスト）
  の順で統一する（更新漏れ・ズレ防止）。

### 5.2 フィルタリング（メンバー×期間の統一）
- 共通関数：`getFilteredRecords({ records, memberId, rangeKey, now })`
  - 期間の基準：**「現在日時からN日遡る（当日含む）」**で統一
  - datetimeはローカル時刻として扱い、境界は `startOfDay` 等で揺れないようにする
  - 0件時：グラフは空状態（非表示または空データ）＋説明文を必ず表示

### 5.3 データ整形（グラフ種別ごと）
- 折れ線/棒（trend viewのみを基本）
  - 日付（YYYY-MM-DD）でグルーピングし、同日複数測定は**平均**（sys/dia/pulse）
  - X軸ラベルは `MM/DD`（年跨ぎは `YY/MM/DD` などへ自動拡張してもよい）
  - 並び順は昇順固定
- 散布図（trend viewのみを基本）
  - 生データ（測定単位）を表示
  - X軸は「日時」または「時刻（0–24h）」のどちらかに統一（実装で決めた方を固定）
  - 点が重なる場合：点は半透明、半径/hover半径を調整、ツールチップ重視
- 目標ライン
  - annotationプラグインは使わず、水平線を**データセットとして追加**（破線・薄色）
  - line/bar：デフォルトONで表示可能（ユーザーがOFFにできる）
  - scatter：視認性が落ちる場合はデフォルトOFF、または極薄で表示

### 5.4 分析ビュー（時間帯/曜日）
- 時間帯別（朝/昼/夜）
  - 暫定定義（ローカル時刻）：朝=4–10時 / 昼=11–16時 / 夜=17–3時
  - 出力：カテゴリ（朝/昼/夜）ごとの平均（sys/dia/pulse）と回数
  - 表示：棒グラフを基本（カテゴリ軸）
  - データ不足：カテゴリごとに n<2 などの場合は注意文を表示
- 曜日別（月〜日）
  - 曜日ラベルは日本語固定（例：月 火 水 木 金 土 日）
  - 並びは必ず「月→日」で固定
  - データがない曜日は 0 または「—」で表示し、エラーにしない
- UI制約
  - ビュー切替（推移/時間帯/曜日）と、グラフ種別切替（line/bar/scatter）が衝突する場合は
    - 推移ビューのみ「line/bar/scatter」有効
    - 時間帯/曜日ビューは「bar」固定
    のようにUI側で無効化/非表示し、迷いを減らす

### 5.5 Chart.js更新方針（メモリリーク防止）
- Chartインスタンスは単一参照で管理し、切替時は以下を徹底
  - `chart.destroy()` → `new Chart(...)`（確実）
  - もしくは `chart.data/options` 更新 → `chart.update()`（要検証）
- canvas要素は使い回し、必要時のみ再生成

## 6. UI/UX・入力操作の規約
- モバイルファースト（360px幅想定）
  - グラフカード内に「コントロール行」を設置（期間→種別→分析の順で優先表示）
  - 狭い場合は折り返し/2段を許容（押しづらくしない）
- 操作UI
  - 期間：セグメントボタン or select（いずれかに統一）
  - 種別：セグメント（line/bar/scatter）
  - 分析ビュー：タブ（推移/時間帯/曜日）
  - 目標：入力（数値）＋表示ON/OFFトグル
- アクセシビリティ
  - タップ領域：48px目安
  - すべてのコントロールに `label` / `aria-label` を付与
  - 空状態：必ず説明文を表示（例：「データがありません」「分析には3件以上が必要」）

## 7. パフォーマンス/品質
- 集計優先
  - line/barは日次集計で点数を抑える
  - 全期間など点数が多い場合：
    - scatterの期間を制限（例：90日まで）または自動で間引き
    - アニメーションを短縮/無効化
- Chart.jsオプション
  - ツールチップ：日時・メンバー・sys/dia/pulseを読みやすく（モバイルはtap前提）
  - 凡例：モバイルで邪魔にならない位置（上/下）を採用、必要ならクリックで表示切替
  - グリッド：薄く、主目盛を強調
- レイアウト
  - 画面回転・リサイズで崩れない（グラフのリサイズ処理を入れる）

## 8. テスト/デバッグ（DoD）
- 単体テスト観点（関数で検証できる形にする）
  - `getFilteredRecords`：境界日（7日前など）で期待通りに含まれる/除外される
  - 日次集計：同日複数測定の平均が正しい
  - 統計：平均/最小/最大/標準偏差/回数が固定サンプルで手計算一致
  - 時間帯分類：境界（3→4時、10→11時、16→17時）で正しく分類
  - 曜日分類：月→日の順序固定、欠けてもエラーにならない
- 結合テスト（手動シナリオ）
  - 記録追加→一覧更新→グラフ/統計/分析が即時更新
  - 削除後に再計算され、古い値が残らない
  - メンバー切替が全ビュー（推移/時間帯/曜日）に反映
  - 期間×種別×メンバーの組合せで表示破綻なし
  - 0件/少数件の空状態でも真っ白にならない
- 受け入れ基準（成功条件）
  - 期間選択・種別切替がモバイルで迷わず操作でき、選択に応じて即時更新（リロード不要）
  - 統計値が選択期間・選択メンバーに正しく追随し、算出ルールが一貫
  - 目標ラインが設定/保存でき、グラフ上で見やすく表示
  - 時間帯別/曜日別のビューが崩れず、データ不足時は説明表示
  - 主要ブラウザ（Android Chrome中心）でエラーなく動作し、既存機能を壊さない

## 9. リリース/更新運用
- `todo.md`/計画md更新時
  - 追加された数値要件（期間・境界・閾値）を `constants` に反映
  - UI項目の増減は「スコープ」と「DoD」を更新
- リグレッションメモ
  - 手動シナリオテスト手順をREADME（またはコメント）に追記し、再現可能にする

## 10. 禁止事項/アンチパターン
- 指定なしで外部FW（React/Vue等）や大型プラグインを導入しない
- フィルタ/集計/統計が別々のロジックで動き、件数や範囲がズレる実装
- setInterval乱用による描画更新（Chart.js更新はイベント駆動＋必要時のみ）
- 魔法数散在（期間/時間帯/閾値/色/点サイズは定数へ）
- 破壊的リファクタで既存機能の挙動を変える（Step1は「挙動変更しない」を厳守）

## 11. コミット/PR運用（任意）
- 1コミット=1意図（例：期間選択UI追加、統計算出追加、目標ライン追加）
- 日本語で「要点→効果→影響範囲」を簡潔に
- PR/Issueには「変更点」「確認観点」「スクショ（可能なら）」を添付

---

### TODO（未確定点の明示）
- 目標血圧の初期値：空で開始（OFF）でよいか／一般値を初期表示するか
- 時間帯境界：ユーザー設定化する必要があるか（現状は定数）
- 標準偏差：母標準偏差/標本標準偏差のどちらで統一するか（初期は母で実装し注記）
- 全期間の負荷対策：散布図の自動制限や間引き閾値（件数ベース）
```

```md
# 生成ログ（短い要約）
- 抽出した主要要件：期間（7/30/90/全）、種別（line/bar/scatter）、統計カード、目標ライン、時間帯/曜日分析、Chart.js UX改善。
- 実装の中核：単一State → 共通フィルタ（member×range）→ データ整形（種別/ビュー別）→ Chart.js更新（destroy徹底）→ 統計/空状態。
- 既存互換：記録/保存/一覧/フィルター/OCR等は壊さない（Step1は挙動変更しない）。
- 自動補完した規約：責務分離、魔法数の定数化、モバイルUI（48px目安）、ARIA付与、0件/少数件の空状態。
- 未確定点：目標初期値、時間帯境界の固定/設定化、標準偏差定義、全期間の間引き閾値。
```

