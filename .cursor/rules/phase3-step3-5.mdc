```md
# ProjectRules.md（Cursor Project Rules 貼り付け用）

## 1. 目的とスコープ
- **目的**: 血圧計の撮影画像に対して、OCR（Tesseract.js）の**認識率と安定性**を上げる（機種差・照明差・角度差に強くする）。
- **スコープ（やること）**:
  - Step 3-5（OCR精度の最適化）を実装・検証・計測できる状態にする。
  - 画像前処理パターンの複数試行、ROI（切り抜き）強化、PSM/パラメータ探索、後処理（誤読補正/妥当性）、ベンチ/デバッグ導線、性能（早期打ち切り/タイムアウト/フォールバック）。
- **非スコープ（やらないこと）**:
  - クラウドOCR/外部送信/学習（ネットワーク前提の処理）。
  - UIの全面刷新（必要最小限のデバッグ表示以外）。
  - サーバー/DB/アカウント機能追加。

## 2. 技術スタック
- **フロント**: HTML / CSS / JavaScript（ES Modules）
- **OCR**: Tesseract.js（`jpn+eng` / `eng` の比較を許容）
- **描画**: Canvas API（前処理/サムネ表示）
- **動作環境**: AndroidのPWA（オフライン完結）
- **依存/前提**:
  - Step 3-1〜3-4 が既に動作している前提（入力フォーム/向き補正/リサイズなど）。
  - 抽出対象は基本「最高（SYS）/最低（DIA）/脈拍（PUL）」の3値。

## 3. ディレクトリ/ファイル方針
- 主要ファイル（既存想定）
  - `index.html`
  - `css/style.css`
  - `js/app.js`（UI連携：自動入力/要確認/再試行）
  - `js/ocr.js`（OCR実行、前処理、抽出、スコアリング、ログ）
- 追加（推奨）
  - `js/constants.js`（OCR設定/閾値/範囲などの定数を集約）
  - `test/ocr-samples/`（代表テスト画像 10〜20枚）
  - `test/ocr-labels.json`（正解ラベル：SYS/DIA/PUL）
  - `test/bench.html`（任意：ブラウザで一括ベンチを回す画面。難しければ `index.html?bench=1` でも可）
- 読み込み順
  - HTML → CSS → JS（`constants.js` → `ocr.js` → `app.js` の順を推奨）
- ルール
  - **魔法数は禁止**。閾値・範囲・試行数・タイムアウト・解像度は `js/constants.js` に集約。
  - **ログ/デバッグUIはフラグで完全に隠す**（通常利用者に露出しない）。

## 4. コーディング規約（横断）
- 命名
  - JS: `lowerCamelCase` / 定数: `UPPER_SNAKE_CASE`
  - CSS: BEM（`block__elem--mod`）か Utility のどちらかに統一（混在させない）
- 構造
  - **層分離**: `constants（設定）` / `domain（抽出・スコア）` / `io（tesseract呼び出し）` / `ui（app.js）` を意識。
  - **純粋関数化**: 抽出・正規化・スコアリングは可能な限り純粋関数（入力→出力）にし、テストしやすくする。
- コメント
  - 原則日本語。関数の先頭に「入力/出力/副作用」を1〜2行で記述。
- エラーハンドリング
  - 例外は握りつぶさない。**分類コード**（タイムアウト/ワーカー失敗/抽出不能/範囲外など）を返す。
- セキュリティ/プライバシー
  - 画像・OCR結果を外部へ送らない。ログ出力はローカルのみ（必要なら JSON ダウンロード）。

## 5. 実装ルール（プロジェクト固有）

### 5.1 OCR試行結果の共通スキーマ（attemptログ基盤）
- `recognizeText()`（またはOCR実行関数）は、**1回のOCRを「複数試行（attempts）」**として扱う。
- 返却オブジェクト例（概念）
  - `attempts[]`: 各試行のメタ情報と結果
  - `selectedAttemptId`: 最終採用した試行ID
  - `selectedReason`: 採用理由（スコア内訳）
  - `errorCode`: 失敗分類（成功時は `null`）
- `attempt` に必ず入れる項目
  - `preprocessName`（例：A/B/C）
  - `roi`（座標/倍率/回転/マージンなど）
  - `resolutionLevel`（例：640/960/1280）
  - `tesseract`（`psm`, `lang`, `whitelist`, その他設定）
  - `rawText`, `confidence`（可能なら words/lines）
  - `normalizedText`（※デバッグ時のみ保持してOK）
  - `candidates[]`（抽出候補：sys/dia/pul + スコア）
  - `scoreBreakdown`（OCR信頼度/抽出スコア/妥当性など）
  - `totalScore`

### 5.2 デバッグモード（詳細ログ/前処理画像の可視化）
- フラグ
  - `?debug=1` または `localStorage.OCR_DEBUG = "1"` でON。
  - 通常時（debug=0）では詳細ログ・サムネ生成・大量文字列保持を**抑制**。
- デバッグ時に見えるもの（UIまたはconsole）
  - 前処理後のサムネ（最大幅 200px 程度）
  - `rawText` / `normalizedText`
  - attempts一覧（採用/不採用、`totalScore`、内訳）
  - （任意）ログを JSON でDLするボタン

### 5.3 前処理パイプライン（複数パターンを回す）
- `preprocessImage()` は「パターン定義配列」で回せる構造にする。
- 最低3パターンを用意（名前は固定してログ比較しやすく）
  - **A**: グレースケール → 単純二値化
  - **B**: コントラスト強調 → 二値化（閾値を調整できる）
  - **C**: エッジ強調（アンシャープ相当） → 二値化
- 各パターンは `meta`（閾値/係数/処理時間など）を返し、attemptに記録する。

### 5.4 ROI（切り抜き）強化：ガイド枠 + 自動微調整
- 既存のガイド枠/ROIを「ベースROI」として必ず残す。
- 追加で ROI 候補を生成
  - 例：上下左右マージンを ±5〜10% 変えた候補、最大 `ROI_CANDIDATES_MAX` 件まで。
  - 可能なら二値化画像の投影（水平/垂直）で「数字密度の高い帯」を推定して微調整。
- ROI候補は attempt として扱い、スコアで最良を採用。

### 5.5 解像度戦略（速度⇄精度の段階フォールバック）
- OCR入力canvasの最大辺を段階化（例：`[640, 960, 1280]`）。
- まず **低解像度 + 軽い前処理**で試行し、スコアが閾値未満なら段階アップ。
- ルール
  - 早期確定閾値: `SCORE_EARLY_ACCEPT` 以上で探索打ち切り。
  - 最大試行数: `ATTEMPTS_MAX` を超えない（試行爆発防止）。

### 5.6 Tesseract設定探索（PSM/言語/whitelist）
- PSM候補を複数試行（最低 `6/7/8`）
  - 推奨探索順（軽い/成功しやすい順に固定）: `7 → 6 → 8`
- 文字制約
  - `tessedit_char_whitelist`: 原則 `0123456789/` を中心に、区切り揺れ吸収のため `|:-` と空白も必要に応じて許容（※最終抽出は後処理で正規化）。
  - `tessedit_char_blacklist`: 明らかなノイズ英字など（必要性はログで検証）。
- 言語モード
  - `jpn+eng` と `eng` の両方を試し、attemptに記録。
  - 最終目的は数値抽出なので、ラベル誤認識より**数値の取り出し**を優先。

### 5.7 後処理（誤読補正 + 正規化）
- rawTextに対して正規化（関数化してテスト可能に）
  - 全角→半角、複数スペース圧縮、改行/タブの整理
  - 典型誤読補正: `O/o→0`, `I/l→1`, `S→5` など（副作用が出るので範囲チェックとセット）
  - 区切り記号統一: `| - ：` 等を `/` 相当に寄せる
- デバッグ時のみ `raw→normalized` の差分を保持（通常時は保持しない）。

### 5.8 候補抽出（複数パターンで候補を増やし、スコアで選別）
- 取り方（最低限）
  - `XXX/YYY`（SYS/DIA）
  - `XXX YYY`（区切りなし・スペース区切り）
  - `SYS/DIA/PUL` ラベル近傍の数字探索（あれば）
  - 2〜3桁数字の組み合わせ列挙 → 範囲/関係でフィルタ
- 候補スコア例（定数化）
  - 範囲内 +20
  - `SYS > DIA` +20
  - 典型レンジへの近さ +α（過学習しない程度に控えめ）
  - OCR confidence平均 +α
  - 区切りが明確 +α
- attempt総合スコア
  - `totalScore = OCR_CONF_WEIGHT * ocrConfidence + EXTRACT_WEIGHT * extractScore - PENALTY` のように合成。
  - **内訳は必ず残す**（デバッグで説明できること）。

### 5.9 妥当性チェック（安全側の失敗）とUI連携
- 範囲チェック（定数化）
  - `SYS: 50–250`, `DIA: 30–150`, `PUL: 40–200`
- 2段階判定
  - **Strict**: 範囲 + `SYS > DIA` を満たす
  - **Relaxed**: 範囲のみ満たす（Strictを満たさない場合は「要確認」）
- UI（`app.js`）との連携
  - 返却に `confidenceLevel`（例：`high/medium/low`）と `needsReview` を含める。
  - `needsReview=true` の場合は自動入力しても**赤表示**などで要確認にし、最終確定はユーザーに委ねる（誤記録防止）。

### 5.10 探索戦略（試行順序・早期打ち切り・タイムアウト）
- 試行順序を固定し「軽い→重い」で探索（例）
  1) 低解像度 × 前処理A × PSM7 × ベースROI
  2) 低解像度 × 前処理A × PSM6 …
  3) 低解像度 × 前処理B …
  4) 解像度アップ …
  5) ROI候補追加 …
- タイムアウト
  - OCR全体に `OCR_TOTAL_TIMEOUT_MS`（例：8〜12秒、端末で調整）
  - タイムアウト時は「現時点のベスト候補を返す」か「失敗扱い」を返し、UIで再試行/手動入力へ。

### 5.11 テスト画像セットと簡易ベンチ（回帰防止）
- `test/ocr-samples/` に代表画像を10〜20枚追加（角度/照明/機種差を意識）。
- `test/ocr-labels.json` に正解ラベル（`systolic/diastolic/pulse`）を保持。
- ベンチ出力（少なくともconsoleでOK）
  - 成功率
    - `SYS/DIA 正解率`
    - `3値（SYS/DIA/PUL）完全一致率`
  - 処理時間: 平均、P95
  - 失敗分類内訳（抽出失敗/範囲外/タイムアウト等）
- 変更前後で比較できるよう、結果をコピー/JSON保存できる導線を用意。

### 5.12 フォールバック導線（失敗時でも詰まらない）
- 低確信時の振る舞いを統一
  - 「自動入力＋要確認」または「自動入力抑止＋要確認」のどちらかに統一（混在禁止）。
- 再試行は最大1回など、回数上限を定数化。
- 撮影ヒント（短文）を用意（例：反射を避ける/明るく/枠内に収める）。

## 6. UI/UX・入力操作の規約
- 通常モード（debug=0）
  - UIは既存導線を維持（OCR→自動入力→必要なら手修正）。
  - 低確信/範囲外は「要確認」表示を必須。
- デバッグモード（debug=1）
  - デバッグ表示は**折りたたみ**または**モーダル**で追加。
  - 画像サムネ/attempt表は縦スクロールで見られるようにする。
- 入力
  - OCRが失敗しても手動入力で完了できること（失敗で詰まらせない）。

## 7. パフォーマンス/品質
- Worker
  - Tesseract Worker は可能な限り再利用（attemptごとに作り直さない）。
- 試行数
  - `ATTEMPTS_MAX` と `ROI_CANDIDATES_MAX` を必ず設ける。
  - `SCORE_EARLY_ACCEPT` で早期確定し、無駄な試行を回さない。
- メモリ
  - 大きいCanvasの使い回し、不要になったImageData/文字列を破棄。
  - rawText/words/画像サムネ等の重いログはデバッグ時のみ。
- 計測
  - attemptごと/全体の処理時間を記録（改善が数字で追えること）。

## 8. テスト/デバッグ（DoD: Definition of Done）
- 最低DoD
  - [ ] 1枚の画像で、前処理A/B/C × PSM 6/7/8 の複数attemptが生成され、`selectedAttemptId` が決まる。
  - [ ] debug=1 のときのみ、前処理サムネ・rawText・attempt一覧が確認できる。
  - [ ] 誤読補正/正規化で、少なくとも1ケース以上「抽出不能→抽出可能」を再現できる。
  - [ ] 妥当性チェック（Strict/Relaxed）で、怪しい結果が「要確認」へ落ちる。
  - [ ] 早期打ち切り/最大試行数/タイムアウトで、無限待ちが発生しない。
  - [ ] テスト画像セットで成功率と処理時間が出力でき、改善の比較が可能。
- 受け入れ指標（暫定）
  - `SYS/DIA 正解率` と `3値完全一致率` の両方を出し、前回ベンチより改善していること。
  - 目標値（例：Phase 3全体で80%）はプロジェクト計画に合わせて定数/READMEに明記する（TODO）。

## 9. リリース/更新運用
- `todo.md / plan.md` 更新が入ったら
  - 変更点（数値・試行数・閾値・ファイル追加）を本ルールの該当箇所へ差分反映。
  - ベンチを回して「成功率/処理時間/失敗内訳」を更新し、回帰がないことを確認。
- ログ/サンプル
  - 個人情報が映り込む画像はサンプルに入れない（表示部のみ/背景を避ける）。

## 10. 禁止事項/アンチパターン
- 指定なしでの外部フレームワーク導入（React/Vue等）
- setInterval 乱用でOCR/描画を回す（タイムアウト/中断不能の温床）
- 魔法数の散在（閾値/範囲/試行数があちこちにある状態）
- ログ常時ON（通常利用で重くなる・プライバシーリスク）
- 画像/認識結果の外部送信、クラウド依存

## 11. コミット/PR運用（任意）
- 1コミット=1意図（例：「前処理パターンB追加」「PSM探索順序固定」）
- メッセージは日本語で「目的→変更→影響」を1行で。
- PR/変更時はベンチ結果（成功率/時間）を貼る。

---

### 付録A: 設定定数の推奨一覧（`js/constants.js`）
- `OCR_DEBUG_DEFAULT`（基本false）
- `ATTEMPTS_MAX`（例：24〜48）
- `ROI_CANDIDATES_MAX`（例：3〜5）
- `RESOLUTION_LEVELS = [640, 960, 1280]`
- `PSM_LIST = [7, 6, 8]`
- `OCR_TOTAL_TIMEOUT_MS`（例：10000）
- `SCORE_EARLY_ACCEPT`（例：85）
- 範囲: `SYS_MIN/MAX`, `DIA_MIN/MAX`, `PUL_MIN/MAX`
- 重み: `OCR_CONF_WEIGHT`, `EXTRACT_WEIGHT`, `PENALTY_*`
- TODO: 実測で閾値を調整（ベンチで根拠を残す）
```

```md
# 生成ログ（要約）
- 抽出した主要要件: 前処理A/B/Cの複数試行、ROI微調整、解像度段階フォールバック、PSM(6/7/8)探索、whitelist/言語モード比較、誤読補正/正規化、候補抽出のスコアリング、Strict/Relaxed妥当性、デバッグモード、早期打ち切り/タイムアウト、テスト画像ベンチ（成功率/時間/P95/失敗内訳）。
- 前提にした点: Tesseract.js（jpn+eng）利用、Step 3-1〜3-4が稼働、対象値はSYS/DIA/PUL、画像は長辺1280px程度に最適化済み。
- 未確定/TODO: リポジトリ実際の構成（`js/constants.js` の有無）、UIの「低確信時の振る舞い」をどちらに統一するか、目標成功率（80%など）の最終定義、試行上限/閾値/タイムアウトの最適値。
- 自動補完した規約: 層分離、魔法数の集中管理、デバッグはフラグで完全遮断、ログは通常時最小化、Worker再利用、ベンチで回帰防止。
```

