```md
## 1. 目的とスコープ（本プロジェクトで何を作るか／作らないか）
- 目的: Chart.js（4.x）で「過去7日分」の血圧推移（最高/最低/脈拍）を折れ線グラフとして表示し、メンバーで絞り込めるようにする。
- スコープ（やる）:
  - グラフ表示UI（canvas + コンテナ + メンバーフィルターUI + 空表示メッセージ）
  - データ処理（過去7日抽出／同日複数は日別平均／昇順ソート／labels・datasets生成）
  - Chart.js描画（3系列＋右Y軸、更新・再描画、フィルター連動）
  - 手動テスト手順（主要ユースケース＋回帰）
- 非スコープ（やらない）:
  - 期間選択（7日固定以外）・ズーム・注釈などの高度機能（Phase 4送り）
  - Chart.js time scale / adapter 等の追加依存（カテゴリ軸で実装する）
  - 既存保存/一覧/削除・Sheets同期の大規模な作り直し（必要最小限のフックのみ）

## 2. 技術スタック
- 使用言語: HTML / CSS / JavaScript
- ライブラリ: Chart.js 4.x（CDN読み込み）
- 前提/依存:
  - 既存の記録データ配列（例: records）を app.js で参照できること
  - 記録データ形: `{ id, member, systolic, diastolic, pulse, datetime(ISO) }`
  - （任意）Sheets連携がある場合は「ローカル即描画→同期後に再描画」を許容

## 3. ディレクトリ/ファイル方針
- 変更対象（原則）:
  - `index.html`（グラフ領域・フィルターUI・Chart.js CDN）
  - `css/style.css`（グラフ領域の高さ/余白/モバイル最適化）
  - `js/app.js`（データ加工＋描画＋更新トリガー）
- 読み込み順（厳守）:
  - `Chart.js（CDN）` → `js/app.js`（自作JS）
- 追加ファイル方針（どちらかに統一。混在させない）:
  - A案（最小改修）: `js/app.js` 内に chart 関連関数を追加（「Chart関連」セクションでまとまる）
  - B案（分離）: `js/chart.js` を新規作成し、`app.js` から呼ぶ（責務分離が明確）
  - TODO: プロジェクトの現状構成に合わせて A/B を選ぶ（選んだら以後固定）

## 4. コーディング規約（言語横断 + 言語別の要点）
- 命名:
  - JS: `lowerCamelCase`、定数は `UPPER_SNAKE_CASE`
  - CSS: BEM（`block__elem--mod`）または Utility のどちらかに統一
- 構造:
  - 「設定/定数」「ドメイン（データ加工）」「I/O（保存・同期）」「UI更新（描画）」を分離
- コメント:
  - 原則日本語。関数の先頭に「何を受け取り、何を返し、副作用があるか」を1行で書く
- 禁止:
  - 魔法数の散在（7日/色/高さなどはまとめて定数化）
  - 入力フォーム用のメンバーselectとグラフ用selectのイベント混同

## 5. 実装ルール（要件を実装ガイドに落とす）
### 5.1 データソースと更新タイミング
- 正のデータ配列は「一覧表示に使っている記録配列」と同一を参照する（二重管理しない）。
- グラフ更新トリガー（最低限）:
  - 初期表示（ローカル読み込み完了時）
  - 新規保存成功後
  - 削除成功後
  - `chartMemberFilter` 変更時
  - （任意）Sheets同期完了時（オンライン時のみ）

### 5.2 「過去7日」の定義と日付扱い
- 7日範囲: **今日を含む直近7日**。
- 境界: ローカルタイムの 0:00 を日付切替点とする。
- datetime:
  - ISO文字列想定。`new Date(datetime)` で Date 化し、日付キーはローカル日付で作る。
  - 日付キー: `YYYY-MM-DD`（ローカル）

### 5.3 抽出→グループ化→平均→ソート→Chart用整形
- フィルター:
  - `memberFilter === 'all'` の場合は無条件に全件対象
  - 個別選択時は `record.member === selectedMember`
- 抽出:
  - 7日範囲外は除外
- グループ化:
  - `YYYY-MM-DD` ごとにまとめる
- 平均:
  - `systolic/diastolic/pulse` を日別平均にする
  - 丸め: UIの見やすさ優先で **整数に四捨五入**（`Math.round`）
  - TODO: 小数1桁表示が必要になったら Phase 4 で見直す
- ソート:
  - 日付の昇順（古い→新しい）。文字列ソート禁止（必ずタイムスタンプで比較）
- 欠損日:
  - MVPでは埋めない（測定がない日は点がない/線が途切れるのを許容）

### 5.4 Chart.js 描画仕様（MVP固定）
- チャート種類: 折れ線（line）
- 3系列:
  - 最高血圧: 赤（左Y: mmHg）
  - 最低血圧: 青（左Y: mmHg）
  - 脈拍: 緑（右Y: bpm / `y1`）
- X軸:
  - カテゴリ（`labels: ['MM/DD', ...]`）
  - time scale / adapter は使わない
- オプション:
  - `responsive: true`
  - `maintainAspectRatio: false`（コンテナ高さで制御する）
  - 凡例/ツールチップ: 有効
  - 軸ラベル: 左 `mmHg`、右 `bpm`

### 5.5 更新/再描画（メモリリーク防止）
- Chartインスタンスは単一保持（例: `bpChartInstance`）。
- 更新手順はどちらかに統一:
  - A案: `instance.destroy()` → `new Chart(...)`（確実だが作り直し）
  - B案: `instance.data = ...` → `instance.update()`（軽いが実装注意）
  - MVPでは A案推奨（点数が最大7点×3系列で軽量）

## 6. UI/UX・入力操作の規約
- 追加UI（index.html）:
  - 「グラフ」セクション（見出し＋簡単な説明）
  - `<canvas id="bpChart">`（描画先）
  - 空表示メッセージ領域（例: `<div id="emptyChartMessage">`）
  - グラフ用メンバーセレクト（例: `<select id="chartMemberFilter">`）
    - 先頭に「全メンバー（all）」
    - 既存の入力フォーム用selectとは **別id** にする
- モバイル前提:
  - セレクト/ボタンのタップ領域は最低44px
  - グラフコンテナ高さ目安: 240〜320px（CSSで調整）
  - 文字/凡例が詰まる場合はフォントサイズ・配置を調整
- 0件時の表示:
  - チャートは非表示（`display:none` 等）または空データ描画のどちらかに統一
  - 代わりに「過去7日分の記録がありません」等のメッセージを必ず出す

## 7. パフォーマンス/品質
- データ加工は更新トリガー時のみ実行（毎フレーム処理は禁止）。
- 7日×3系列のため基本は軽いが、以下を守る:
  - 不要なDOM探索を避け、要素参照はキャッシュ
  - 再描画前にインスタンス破棄（重なり防止）
- オフライン考慮（将来）:
  - Chart.js CDN はオフラインで読めない可能性あり
  - Phase 4 で PWA キャッシュ対象に含めることを検討（このPhaseでは準備のみ）

## 8. テスト/デバッグ（DoD）
- 手動テスト（最低限すべて合格）:
  1) 初期表示: データ0件 → 空表示メッセージが出る
  2) 1〜6日分: 欠けても描画できる（エラー/崩れなし）
  3) 7日以上: 直近7日だけ表示される（境界日が正しい）
  4) 同日複数: 日別平均になっている（例: 120/80/70 と 140/90/80 → 130/85/75）
  5) フィルター: 全員/個別で即更新される（入力フォームselectに影響しない）
  6) 追加: 記録追加後、リロードなしでグラフに反映
  7) 削除: 記録削除後、リロードなしでグラフから消える
  8) 回帰: 既存の保存/一覧/削除が正常動作
  9) 実機: Android Chrome で表示崩れ/操作性を確認（横向きも）
  10) （任意）オフライン: ローカルデータがある場合に表示できる
- デバッグ方針:
  - 生成した `labels` と `datasets` を一度 console 出力して、長さ一致・昇順を確認
  - 日付キー生成（YYYY-MM-DD）がローカル日付であることを検証

## 9. リリース/更新運用（todo更新時の差分反映）
- 仕様変更が入ったら、まずこのルールの「数値・範囲・軸・UI id」を更新してから実装する。
- 変更時は以下を必ず残す:
  - 7日範囲の定義（今日含む/境界）
  - 丸めルール（四捨五入/小数）
  - データソース（ローカルのみ or Sheets同期含む）

## 10. 禁止事項/アンチパターン
- time adapter等の追加ライブラリ導入（依存増）
- グラフ用selectと入力用selectのID流用/イベント共有
- Chartインスタンスを破棄せず再生成して重ね描きすること
- 7日/色/高さ等をコード中にベタ書きして散在させること
- 既存の保存/一覧/削除ロジックを「ついでに」大改修すること（目的外）

## 11. コミット/PR運用（任意）
- 1コミット=1意図（UI追加／データ加工／Chart描画／連動／CSS調整／テスト手順 などで分ける）
- メッセージは日本語で「何を・なぜ・影響範囲」を短く書く
```

```md
【生成ログ】
- 主要要件: Chart.js 4.x（CDN）で過去7日（今日含む）を3系列（最高/最低/脈拍）折れ線表示、脈拍は右Y軸、同日複数は日別平均、メンバーフィルターで更新。
- UI要件: グラフセクション＋canvas＋空表示メッセージ＋グラフ用メンバーselect（入力用selectと別id）、スマホ最適化（タップ領域44px、コンテナ高さ240〜320px）。
- 実装補完: 欠損日は埋めない（MVP）、平均は整数四捨五入、X軸はMM/DDカテゴリでtime adapterを使わない。
- 未確定/TODO: データソースを「ローカルのみ」or「Sheets同期結果も含む」どちらを正とするか（ルール上はローカル即描画→同期後再描画を許容）。
- ファイル構成の補完: app.js内にまとめる（A案）か chart.js分離（B案）かを選択して固定。
```

