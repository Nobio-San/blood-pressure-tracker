# Phase 2 Step 2-2: 撮影画像プレビュー機能 - テストガイド

## 実装完了内容

### ✅ 実装された機能

1. **状態遷移管理**
   - `CAMERA_PREVIEW` / `PROCESSING` / `PHOTO_PREVIEW` の3状態
   - 状態に応じたUI切り替え

2. **画像プレビュー画面**
   - 撮影後のフルスクリーンプレビュー
   - 「再撮影」「回転」「この画像を使う」ボタン

3. **画像処理**
   - 長辺1280px目安の自動縮小
   - JPEG品質0.8での圧縮
   - Base64形式への変換

4. **画像向き補正**
   - 90度回転ボタンによる手動補正
   - オリジナル画像を保持して回転時の品質劣化を防止

5. **一時保存**
   - sessionStorageへの保存（キー: `bp:lastCapturedImage`）
   - 保存失敗時の品質低下リトライ機能

6. **メモリリーク対策**
   - Object URLの適切な破棄
   - 再撮影時のクリーンアップ
   - モーダル閉じる時のリソース解放

## テストシナリオ

### 基本フロー

#### テスト 1: 撮影→プレビュー→採用
1. ブラウザで `https://localhost:8000` にアクセス
2. 「カメラで撮影」ボタンをクリック
3. カメラ権限を許可
4. 「📸 シャッター」ボタンをクリック
5. **確認点**:
   - 画像処理中に「画像を処理中...」ローディングが表示される
   - 処理後、プレビュー画面に切り替わる
   - 撮影した画像が大きく表示される
   - 「再撮影」「🔄 回転」「✓ この画像を使う」ボタンが表示される
6. 「✓ この画像を使う」をクリック
7. **確認点**:
   - 「画像を保存しました」メッセージが表示される
   - モーダルが閉じる
   - DevTools → Application → Session Storage → `bp:lastCapturedImage` に画像データが保存されている
   - JSONに `base64`, `width`, `height`, `mime`, `createdAt`, `rotation` が含まれている

#### テスト 2: 撮影→プレビュー→再撮影
1. 「カメラで撮影」をクリック
2. 「📸 シャッター」をクリック
3. プレビュー画面で「再撮影」をクリック
4. **確認点**:
   - カメラプレビューに戻る
   - 「📸 シャッター」ボタンが再び表示される
   - 黒画面にならず、カメラストリームが継続している
5. もう一度「📸 シャッター」をクリック
6. **確認点**:
   - 再度プレビューが表示される

#### テスト 3: 画像回転
1. 「カメラで撮影」→「📸 シャッター」
2. プレビュー画面で「🔄 回転」を3回クリック
3. **確認点**:
   - クリックごとに画像が90度ずつ回転する
   - 「回転中...」表示が出る
   - 回転中はボタンがdisabledになる
4. 「✓ この画像を使う」をクリック
5. DevTools で `rotation` フィールドが `270` になっていることを確認

### エッジケーステスト

#### テスト 4: 連続撮影（10回）
1. 以下を10回繰り返す:
   - 「カメラで撮影」
   - 「📸 シャッター」
   - 「再撮影」
2. **確認点**:
   - 10回目でも動作が遅くならない
   - メモリリークが発生しない（DevTools Performance Monitor で確認）
   - カメラが黒画面にならない

#### テスト 5: 縮小・圧縮の確認
1. 高解像度のディスプレイ（紙に文字を書いたもの等）を撮影
2. 「✓ この画像を使う」で保存
3. DevTools → Session Storage で `base64` のサイズを確認
4. **確認点**:
   - `width` または `height` のどちらかが1280以下になっている
   - Base64のサイズが数MB以下（目安: 200KB〜500KB程度）
   - 画質が視認可能（数字が読める程度）

#### テスト 6: エラーハンドリング
1. カメラアクセス拒否時:
   - カメラ権限を拒否
   - **確認点**: エラーメッセージが表示される
2. モーダルを閉じる:
   - プレビュー表示中に「✕ 閉じる」をクリック
   - **確認点**: カメラが停止し、sessionStorageに保存されない
3. Escキーで閉じる:
   - プレビュー表示中にEscキーを押す
   - **確認点**: カメラが停止し、モーダルが閉じる

#### テスト 7: 縦持ち/横持ち
1. スマートフォンを縦持ちで撮影
2. **確認点**: 画像が正しい向きで表示される
3. スマートフォンを横持ちで撮影
4. **確認点**: 必要に応じて回転ボタンで修正できる

#### テスト 8: 保存容量上限
1. 複数回撮影→保存を繰り返す
2. **確認点**:
   - 既存のデータが上書きされる（1件のみ保持）
   - 保存失敗時は品質を下げて再試行する
   - 失敗時にエラーメッセージが表示される

### アクセシビリティテスト

#### テスト 9: キーボード操作
1. Tabキーでフォーカス移動
2. **確認点**:
   - すべてのボタンにフォーカスが当たる
   - フォーカス表示が明確
   - Enterキーでボタンが押せる

#### テスト 10: スクリーンリーダー
1. スクリーンリーダーを有効にして操作
2. **確認点**:
   - ボタンのラベルが読み上げられる
   - ローディング状態が通知される
   - エラーメッセージが読み上げられる

## 既知の制約・今後の改善点

### 制約
1. **端末向き自動補正**: 現時点では手動回転のみ対応（自動補正はベストエフォート）
2. **画像形式**: JPEGのみ対応（PNG対応はPhase 3で検討）
3. **保存先**: sessionStorageのみ（永続化はPhase 4で対応予定）

### 今後の改善
1. **Step 2-4**: 入力フォームへの自動反映（OCR結果の反映）
2. **Phase 3**: OCR処理との連携
3. **Phase 4**: IndexedDBへの永続保存
4. **端末別チューニング**: カメラの向き自動補正の精度向上

## デバッグ方法

### ログ確認
- `camera.js` の `DEBUG_MODE` が `true` の場合、コンソールに詳細ログが出力される
- 状態遷移、画像処理、保存処理の各ステップがログに記録される

### sessionStorage確認
```javascript
// コンソールで実行
const data = sessionStorage.getItem('bp:lastCapturedImage');
const parsed = JSON.parse(data);
console.log('Width:', parsed.width);
console.log('Height:', parsed.height);
console.log('MIME:', parsed.mime);
console.log('Created:', parsed.createdAt);
console.log('Rotation:', parsed.rotation);
console.log('Base64 size:', parsed.base64.length);
```

### Object URL確認
- `[Camera]` で始まるログを確認
- Object URLが適切にrevokeされているか確認

## 成功条件（Done）

以下がすべて満たされていれば完了:

- ✅ 撮影後にプレビュー画面が表示される
- ✅ 「再撮影」でカメラプレビューへ戻れる
- ✅ 「この画像を使う」で sessionStorage に保存される
- ✅ 画像が長辺1280px目安に縮小される
- ✅ 回転ボタンで画像向きを修正できる
- ✅ 連続撮影（10回以上）で落ちない/重くならない
- ✅ リソースが適切にクリーンアップされる

## 実装ファイル

### 変更されたファイル
1. `js/camera.js`: 画像処理、プレビュー機能、状態遷移
2. `js/app.js`: イベントハンドラ、UI制御
3. `index.html`: プレビュー画面DOM、ボタン追加
4. `css/style.css`: プレビュー画面スタイル、Safe Area対応

### 新規追加された定数
- `RESIZE_MAX_EDGE = 1280`
- `JPEG_QUALITY = 0.8`
- `OUTPUT_MIME = 'image/jpeg'`
- `STORAGE_KEY = 'bp:lastCapturedImage'`

### 新規追加された関数
- `optimizeImage()`: 画像縮小・圧縮・回転
- `processCapturedPhoto()`: 撮影後の処理フロー
- `retakePhoto()`: 再撮影
- `rotatePhoto()`: 画像回転
- `usePhoto()`: 画像採用・保存
- `saveToSessionStorage()`: sessionStorage保存
- `clearSessionStorage()`: sessionStorage削除
- `revokeCurrentObjectUrl()`: Object URL破棄

## テスト実行手順

1. HTTPSサーバー起動:
   ```bash
   python https_server.py
   ```

2. ブラウザで https://localhost:8000 にアクセス

3. 上記テストシナリオを順番に実行

4. 各テストの確認点をチェック

5. 問題があればコンソールログとDevToolsで原因を調査

---

**実装完了日**: 2026-02-09
**次のステップ**: Phase 2 Step 2-3（撮影ガイド機能）またはStep 2-4（入力画面への反映）
